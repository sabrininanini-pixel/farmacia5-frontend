																																																																										<!DOCTYPE html>
<html lang="pt-br">
<head>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
	
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferir Nota Fiscal</title>
    <script src="https://cdn.tailwindcss.com"></script>



	
    <!-- âœ… CACHE BUSTING - FORÃ‡A ATUALIZAÃ‡ÃƒO -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
   <style>
    /* âœ… NOVO ESTILO BASE - MODERNO */
    :root {
        --primary: #6388f1;
        --primary-dark: #4f46e5;
        --secondary: #6c757d;
        --success: #10b981;
        --light: #f8f9fa;
        --dark: #374151;
        --border: #e5e7eb;
        --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        --font-main: 'Poppins', sans-serif;
        --bg-color: #f8fafc;
    }
    
    body {
        font-family: var(--font-main) !important;
        background-color: var(--bg-color);
        color: var(--dark);
        line-height: 1.6;
    }

    .mock-table th, .mock-table td {
        padding: 14px 16px !important;
        text-align: left;
        border-bottom: 1px solid var(--border); 
        border-right: 1px solid var(--border); 
        font-family: var(--font-main) !important;
    }
    
    .mock-table th:last-child, .mock-table td:last-child {
        border-right: none;
    }

    .mock-table th {
        font-weight: 600 !important;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--dark) !important;
        background-color: var(--light) !important;
    }
    
	   .mock-table tr:hover:not(#contagem-table tr) {
    background-color: #f8f9fa !important;
}

    /* âœ… HEADER CORRIGIDO - SEM SCROLL HORIZONTAL */
header.print-hidden {
    background: 
        repeating-linear-gradient(0deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 2px, transparent 2px, transparent 4px),
        linear-gradient(135deg, #0f172a, #1e1b4b) !important;
    color: white;
    margin: 0;
    padding: 16px 0;
    width: 100%; /* âœ… MUDOU DE 100vw PARA 100% */
    position: relative;
    overflow: hidden; /* âœ… JÃ ESTAVA CORRETO */
    font-family: var(--font-main) !important;
    /* âŒ REMOVE: margin-left: calc(-50vw + 50%) */
}

/* âœ… GARANTIR QUE O CONTEÃšDO INTERNO NÃƒO CAUSE SCROLL */
header.print-hidden .w-full {
    max-width: 100%;
    box-sizing: border-box;
}

/* âœ… CORREÃ‡ÃƒO EXTRA PARA O BODY */
body {
    overflow-x: hidden; /* âœ… IMPEDE SCROLL HORIZONTAL NO BODY */
    max-width: 100vw;
}
    /* ðŸ”¥ MANTENHA O RESTO DO SEU CSS ATUAL AQUI (modo scroll, impressÃ£o, etc) */
    /* ---------------------------------------------------------------- */
    /* --- Estilos de EdiÃ§Ã£o/ConferÃªncia --- */
    /* ---------------------------------------------------------------- */
    
    /* Estilos base para a coluna DiferenÃ§a (5Âª coluna visÃ­vel) */
    #conferencia-content tr td:nth-child(5) { 
        font-weight: bold;
        text-align: center; 
    }

    /* ---------------------------------------------------------------- */
    /* --- LARGURAS FIXAS GERAIS (DEFAULT TRUNCADO) --- */
    /* --- Esta regra Ã© "desligada" pela classe .expand-mode-cell --- */
    /* ---------------------------------------------------------------- */
    
    /* Coluna 1 (CÃ³digo de Barras - 210px) da ConferÃªncia */
    
	/*  
	#conferencia-table th:nth-child(1),
    #conferencia-table td:nth-child(1) {
         width: 210px; 
         min-width: 210px;
         max-width: 210px;
         overflow: hidden; 
         text-overflow: ellipsis;
         white-space: nowrap;
    }
    */
	   
    /* Colunas numÃ©ricas/estreitas (70px) da ConferÃªncia 
    #conferencia-table th:nth-child(3), 
    #conferencia-table td:nth-child(3),
    #conferencia-table th:nth-child(4), 
    #conferencia-table td:nth-child(4),
    #conferencia-table th:nth-child(5), 
    #conferencia-table td:nth-child(5),
    #conferencia-table th:nth-child(6), 
    #conferencia-table td:nth-child(6) {
         width: 70px; 
         min-width: 70px;
         max-width: 70px;
         overflow: hidden; 
         text-overflow: ellipsis;
         white-space: nowrap;
    }
    
    /* Colunas numÃ©ricas/estreitas (70px) da Nota Fiscal 
    #notafiscal-table th:nth-child(2),
    #notafiscal-table td:nth-child(2),
    #notafiscal-table th:nth-child(4),
    #notafiscal-table td:nth-child(4) {
         width: 70px; 
         min-width: 70px;
         max-width: 70px;
         overflow: hidden; 
         text-overflow: ellipsis;
         white-space: nowrap;
         text-align: center; 
    }
*/
    /* Coluna CÃ³digo de Barras (300px) da Contagem Loja */
    #contagem-table th:nth-child(1),
    #contagem-table td:nth-child(1) {
        width: 300px !important;
        min-width: 300px !important;
        max-width: 300px !important;
        overflow: hidden; 
        text-overflow: ellipsis;
        white-space: nowrap;
        text-align: left;
    }

    /* Coluna DescriÃ§Ã£o da Contagem Loja - CORRIGIDA: REMOVIDO PADDING E ALINHAMENTO Ã€ ESQUERDA */
    #contagem-table th:nth-child(2),
    #contagem-table td:nth-child(2) {
        padding-left: 0 !important;
        width: auto;
        text-align: left !important;
    }

    /* Centraliza os valores numÃ©ricos da CONFERENCIA */
    #conferencia-table td:nth-child(3), 
    #conferencia-table td:nth-child(4),
    #conferencia-table td:nth-child(5) {
         text-align: center; 
    }

    /* ---------------------------------------------------------------- */
    /* --- ESTILOS DE MODO (TOGGLE POR JS) --- */
    /* ---------------------------------------------------------------- */

    /* Estilo base para MODO EXPANDIDO */
    .expand-mode-cell {
        max-width: none !important;
        min-width: 0 !important;
        overflow-x: visible !important;
        white-space: normal !important;
    }


    /* Classe para MODO SCROLL (COLUNAS DE DESCRIÃ‡ÃƒO E TEXTO LONGO - 150px) */
    .scroll-mode-cell {
        max-width: 150px !important; 
        min-width: 150px !important;
        overflow-x: auto !important; 
        white-space: nowrap !important; 
        text-overflow: clip !important;
    }
    
    /* Classe para MODO SCROLL (COLUNAS NUMÃ‰RICAS OU ESTREITAS - 70px) */
    .scroll-mode-cell-numeric {
        width: 70px !important; 
        min-width: 70px !important;
        max-width: 70px !important;
        overflow-x: auto !important; 
        white-space: nowrap !important;
        text-overflow: clip !important;
        text-align: left !important;
    }
    
    /* Classe para CÃ³digo de Barras (210px) */
    .scroll-mode-cell-code {
        width: 210px !important; 
        min-width: 210px !important;
        max-width: 210px !important;
        overflow-x: auto !important; 
        white-space: nowrap !important;
        text-overflow: clip !important;
        text-align: left !important;
    }

    /* Classes usadas pelo JavaScript para aplicar as cores */
    .bg-fee2e2 { background-color: #fee2e2; }
    .text-b91c1c { color: #b91c1c; }
    .bg-green-100 { background-color: #d1fae5; }
    .text-green-700 { color: #047857; }

    /* Estilo para linhas com cÃ³digo mas sem descriÃ§Ã£o na Contagem Loja */
    .bg-red-50 {
        background-color: #fecaca !important;
    }

    .bg-red-50:hover {
        background-color: #fecaca !important;
    }

    /* Estilo para cÃ©lulas editÃ¡veis */
    [contenteditable="true"]:focus {
        outline: none;
        box-shadow: 0 0 0 2px #c7d2fe; 
    }
    
    /* ---------------------------------------------------------------- */
    /* --- Estilos de ImpressÃ£o (A4) --- */
    /* ---------------------------------------------------------------- */
   @media print {
    * {
        box-sizing: border-box;
    }
    
    body {
        margin: 0 !important;
        padding: 10px !important;
        width: 100% !important;
        min-height: 297mm;
        font-size: 10pt !important;
        line-height: 1.2 !important;
        background: white !important;
        color: black !important;
    }

    .container, .bg-white, .shadow-lg {
        box-shadow: none !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: none !important;
        border: none !important;
        background: white !important;
    }
    
    /* Ocultar elementos nÃ£o essenciais */
    header, nav, #paste-modal, #notifications-container, .print-hidden,
    .flex.border-b, .flex.flex-wrap, button, .tab-button {
        display: none !important;
    }

    /* âœ… CORREÃ‡ÃƒO DA TABELA - FORÃ‡AR CABER NA PÃGINA */
    .mock-table {
        width: 100% !important;
        max-width: 100% !important;
        font-size: 8pt !important;
        border-collapse: collapse;
        page-break-inside: auto;
    }
    
    .mock-table th, .mock-table td {
        padding: 3px 4px !important;
        border: 1px solid #ccc !important;
        font-size: 8pt !important;
        line-height: 1.1 !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .mock-table th {
        background-color: #f8f9fa !important;
        font-weight: bold !important;
        color: black !important;
    }
    
    /* âœ… REMOVER TODOS OS MODOS DE LARGURA FIXA NA IMPRESSÃƒO */
    .scroll-mode-cell, .scroll-mode-cell-numeric, .expand-mode-cell, 
    .scroll-mode-cell-code, .truncate-mode-cell {
        max-width: none !important;
        min-width: auto !important;
        width: auto !important;
        overflow: visible !important;
        white-space: normal !important;
        text-overflow: clip !important;
    }
    
    /* âœ… FORÃ‡AR QUEBRA DE TEXTO LONGO */
    .mock-table td {
        word-break: break-word;
        hyphens: auto;
    }
    
    /* âœ… AJUSTAR LARGURAS ESPECÃFICAS DAS COLUNAS PARA IMPRESSÃƒO */
    #conferencia-table th:nth-child(1),
    #conferencia-table td:nth-child(1) {
        width: 15% !important; /* CÃ³digo de Barras */
    }
    
    #conferencia-table th:nth-child(2),
    #conferencia-table td:nth-child(2) {
        width: 40% !important; /* DescriÃ§Ã£o */
    }
    
    #conferencia-table th:nth-child(3),
    #conferencia-table td:nth-child(3),
    #conferencia-table th:nth-child(4),
    #conferencia-table td:nth-child(4),
    #conferencia-table th:nth-child(5),
    #conferencia-table td:nth-child(5),
    #conferencia-table th:nth-child(6),
    #conferencia-table td:nth-child(6) {
        width: 10% !important; /* Colunas numÃ©ricas */
        text-align: center !important;
    }
    
    /* âœ… MANTER CORES DAS DIVERGÃŠNCIAS MESMO NA IMPRESSÃƒO */
    .bg-fee2e2, .text-b91c1c {
        background-color: #fee2e2 !important;
        color: #b91c1c !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .bg-green-100, .text-green-700 {
        background-color: #d1fae5 !important;
        color: #047857 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .bg-yellow-50 {
        background-color: #fefce8 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* âœ… EVITAR QUEBRA DE LINHA NO MEIO DA LINHA */
    .mock-table tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
    
    /* âœ… CABEÃ‡ALHO FIXO NA IMPRESSÃƒO (se possÃ­vel) */
    .mock-table thead {
        display: table-header-group;
    }
    
    .mock-table th {
        position: static !important;
    }
    
    /* âœ… INFORMAÃ‡Ã•ES DAS NOTAS FISCAIS NA IMPRESSÃƒO */
    .mb-4 {
        margin-bottom: 8px !important;
    }
    
    .mb-4 > div {
        background: #e5e7eb !important;
        padding: 4px 6px !important;
        margin-bottom: 2px !important;
        font-size: 7pt !important;
        border: 1px solid #d1d5db !important;
    }

	       .bg-red-100 {
        background-color: #fee2e2 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

	    /* âœ… OCULTAR COLUNA AJUSTAR NA IMPRESSÃƒO */
    #conferencia-table th:nth-child(6),
    #conferencia-table td:nth-child(6) {
        display: none !important;
    }

}
    
    /* ---------------------------------------------------------------- */
    /* --- Ajuste de NotificaÃ§Ã£o para Mobile (CompactaÃ§Ã£o) --- */
    /* ---------------------------------------------------------------- */
    @media (max-width: 640px) {
        #notifications-container > div {
            padding: 0.5rem !important; 
            gap: 0.5rem !important; 
            max-width: 80vw;
        }
        
        #notifications-container > div p {
            font-size: 0.875rem !important;
        }
        
        #notifications-container > div svg {
            width: 1.25rem !important;
            height: 1.25rem !important;
        }
    }

    /* RESPONSIVO */
    @media (max-width: 768px) {
        header .flex {
            flex-direction: column;
            gap: 5px;
        }
        
        .nf-info {
            flex-direction: column;
            gap: 5px;
        }
        
        /* âœ… HEADER MOBILE COM NOVO ESTILO */
        header.print-hidden {
            padding: 10px 0 !important;
        }
    }


/* ðŸ”¥ CORREÃ‡ÃƒO DEFINITIVA PARA HEADER MOBILE/DESKTOP */
.header-mobile {
    display: none;
}

.header-desktop {
    display: none;
}

@media (max-width: 767px) {
    .header-mobile {
        display: flex !important;
    }
}

@media (min-width: 768px) {
    .header-desktop {
        display: flex !important;
    }
}


	   /* CONTIDAS AS ABAS DO CONTADOR*/
	   
	   @media (max-width: 767px) {

    /* Menu de contadores - contido e com scroll interno */
    .flex.border-b.border-gray-200.mb-4.print-hidden {
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
		padding-bottom: 14px;

		
}

	   #content-stack {
    margin-top: 0 !important;
    padding-top: 0 !important;
    gap: 0 !important;
}
}
	   
	   #content-stack {
    margin-top: 0 !important;
    padding-top: 0 !important;
    gap: 0 !important;

		   .bg-red-100 {
    background-color: #fee2e2 !important; /* Vermelho bem suave */
}

.bg-red-100:hover {
    background-color: #fecaca !important; /* Vermelho um pouco mais forte no hover */
}

		   .igualar-btn {
    background: transparent !important;
    color: #4B5563 !important; /* Cor cinza (texto normal) */
    border: 1px solid transparent !important;
    transition: all 0.2s ease-in-out;
}

.igualar-btn:hover {
    background: #F3F4F6 !important; /* Cinza muito claro no hover */
    border-color: #D1D5DB !important; /* Borda cinza no hover */
    color: #374151 !important; /* Texto um pouco mais escuro no hover */
}

/* Estilos para o sistema de Danos/Defeito - MELHORADO */
.menu-danos-defeito {
    animation: fadeIn 0.2s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* âœ… VERSÃƒO SIMPLES E EFETIVA */
.descricao-danos {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;
    padding: 1px 2px !important;
    width: 100%;
    cursor: text;
    min-height: auto !important;
    height: auto !important;
    line-height: 1.2 !important;
}

.descricao-danos:focus {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;
}
.opcao-danos-btn {
    transition: all 0.2s ease;
    min-width: 20px;
    min-height: 20px;
    font-size: 16px;
    font-weight: 400;
    /* âœ… SEM BACKGROUND, APENAS TEXTO */
    background: none !important;
    border: none !important;
    opacity: 1 !important;
}

.opcao-danos-btn:hover {
    color: #374151 !important;
    transform: scale(1.1);
}

/* ðŸ”§ MODO DESKTOP PARA MOBILE - CSS ULTRA FORÃ‡ADO */
.modo-desktop-ativo body {
    min-width: 1024px !important;
    overflow-x: auto !important;
}

.modo-desktop-ativo #main-system,
.modo-desktop-ativo #login-screen {
    min-width: 1024px !important;
    transform: none !important;
    width: 100% !important;
}

/* ðŸ”§ BOTÃƒO MODO DESKTOP - FORÃ‡ADO */
.btn-desktop-mode {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    padding: 8px 16px !important;
    background: #d1fae5 !important;
    color: #065f46 !important;
    border: 1px solid #a7f3d0 !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    white-space: nowrap !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
}

/*  ESSA Ã‰ A SOLUÃ‡ÃƒO - ForÃ§ar display em TODAS as situaÃ§Ãµes */
.btn-desktop-mode.mobile-only {
    display: none !important;
}

/* No mobile normal */
@media (max-width: 767px) {
    .btn-desktop-mode.mobile-only {
        display: flex !important;
    }
}

/*  MAIS IMPORTANTE - Sobreviver ao modo desktop */
.modo-desktop-ativo .btn-desktop-mode,
.modo-desktop-ativo .btn-desktop-mode.mobile-only {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 9999 !important;
}

/* Estado ativo */
.modo-desktop-ativo .btn-desktop-mode {
    background: #10b981 !important;
    color: white !important;
    border-color: #059669 !important;
}

		   
		   
</style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Sistema de ConferÃªncia</h1>
                    <p class="text-gray-600">FaÃ§a login para continuar</p>
                </div>
                
                <div class="mb-6">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">UsuÃ¡rio</label>
                    <input 
                        type="text" 
                        id="username" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Digite seu usuÃ¡rio"
                    >
                </div>

                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="password" 
                            class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Digite sua senha"
                        >
                        <button 
                            type="button" 
                            id="toggle-password"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                            onclick="togglePasswordVisibility()"
                        >
                            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                            </svg>
                        </button>
                    </div>
                </div>

                <button 
                    onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 font-medium"
                >
                    Entrar
                </button>
                
            </div>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL (inicialmente oculto) -->
    <div id="main-system" class="hidden">
        <div class="mx-auto px-0 py-0 md:px-8">
            <header class="print-hidden" style="background: linear-gradient(135deg, #1e3a8a, #3730a3); color: white; margin: 0; padding: 16px 0; width: 100vw; margin-left: calc(-50vw + 50%);">
    <div class="w-full">
       <!-- MOBILE LAYOUT - COM DISPLAY CONDICIONAL -->
<div class="header-mobile" style="align-items: center; justify-content: space-between; padding: 8px 12px; font-family: 'Poppins', sans-serif;">
    <!-- LOGO Ã€ ESQUERDA -->
    <a href="https://www.gtgo.com.br" style="text-decoration: none; color: inherit; flex-shrink: 0;">
        <div style="font-size: 14px; font-weight: bold; white-space: nowrap;">GTGO</div>
    </a>
    
    <!-- TÃTULO CENTRAL COMPACTO -->
    <div style="flex: 1; text-align: center; margin: 0 8px; min-width: 0;">
        <h1 style="font-size: 12px; font-weight: 600; line-height: 1.2; margin: 0; overflow: hidden; text-overflow: ellipsis;">Conferir NFe</h1>
        <p style="font-size: 10px; opacity: 0.9; margin: 0; overflow: hidden; text-overflow: ellipsis;">Sistema de conferencia e gestÃ£o de notas fiscais</p>
    </div>
    
    <!-- BOTÃƒO SAIR COMPACTO -->
    <button onclick="logout()" style="flex-shrink: 0; display: flex; align-items: center; gap: 4px; padding: 6px 8px; border-radius: 6px; font-size: 11px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; white-space: nowrap;">
        <i class="fas fa-sign-out-alt"></i>
        <span>Sair</span>
    </button>
</div>
        <!-- DESKTOP LAYOUT -->
      <div class="header-desktop justify-between items-center max-w-7xl mx-auto px-4">
            <!-- LOGO GTGO COM LINK -->
            <a href="https://www.gtgo.com.br" class="flex flex-col items-center text-center" style="text-decoration: none; color: inherit;">
                <div class="text-xl font-bold">GTGO</div>
                <div class="text-xs opacity-90 mt-1">GestÃ£o AvanÃ§ada</div>
            </a>
            
            <!-- TÃTULO CENTRAL -->
            <div class="flex-1 text-center">
                <h1 class="text-2xl font-semibold mb-1">Conferir NFe</h1>
                <p class="text-sm opacity-90 max-w-md mx-auto">Sistema de conferencia e gestÃ£o de notas fiscais</p>
            </div>
            
            <!-- BOTÃƒO SAIR ESTILIZADO -->
            <button onclick="logout()" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition duration-150 text-sm font-medium border"
                    style="background: rgba(255, 255, 255, 0.2); color: white; border-color: rgba(255, 255, 255, 0.3);">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sair</span>
            </button>
        </div>
    </div>
</header>

            <div class="bg-white rounded-xl shadow-lg border border-gray-100 px-0 pt-6 pb-6 md:p-6">

                <nav class="flex border-b border-gray-200 print-hidden">
                    <button data-tab="NOTA FISCAL" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 transition-colors duration-150">NOTA FISCAL</button>
                    <button data-tab="CONTAGEM LOJA" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">CONTAGEM LOJA</button>
                    <button data-tab="CONFERENCIA" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">CONFERENCIA</button>
                </nav>



<!-- âœ… BOTÃƒO DE BUSCA UNIVERSAL COM X INTERNO -->
<div class="flex flex-wrap gap-3 pb-3 mb-3 border-b border-gray-200 print-hidden mt-3">
    <div class="relative flex-1 min-w-[300px]">
        <input 
            type="text" 
            id="global-search-input"
            placeholder="Buscar em todas as colunas..." 
            class="w-full px-4 py-2 pl-10 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
        <!-- Ãcone de busca (esquerda) -->
        <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <!-- BotÃ£o X (direita) - aparece apenas quando tem texto -->
        <button 
            id="clear-search-button"
            onclick="clearSearch()"
            class="absolute right-3 top-2.5 h-5 w-5 text-gray-400 hover:text-gray-600 transition duration-150 hidden"
        >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
</div>
				
                <div id="content-stack" class="pt-6">
                </div>

				
				
            </div>
        </div>

        <div id="paste-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 print-hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 p-6">
                <h3 class="text-lg font-bold mb-4">Colar Chave de Acesso (44 dÃ­gitos)</h3>
                <textarea id="chave-acesso-input" class="w-full h-24 p-3 border border-gray-300 rounded-lg resize-none text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="Cole a Chave de Acesso (44 dÃ­gitos) aqui..."></textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="hidePasteModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button onclick="importarXMLPorChave()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">Importar XML por Chave</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICAÃ‡Ã•ES FORA DA MAIN-SYSTEM (SEMPRE VISÃVEIS) -->
    <div id="notifications-container" class="fixed bottom-4 right-4 space-y-2 z-50 print-hidden">
    </div>

    <script>
        // =========================================================================
        // CONFIGURAÃ‡ÃƒO PARA ONLINE - MUDANÃ‡A PRINCIPAL
        // =========================================================================
        const BACKEND_URL = "https://api.gtgo.com.br"; // URL do backend online
        const USER_ID = "web-user-123";
        
        // =========================================================================
        // SISTEMA DE AUTENTICAÃ‡ÃƒO CORRIGIDO
        // =========================================================================

        let currentUser = null;

        /**
         * âœ… SISTEMA DE LEMBRAR LOGIN - VERSÃƒO FORTE
         */
        function setupLoginRemember() {
            console.log("ðŸ”§ Iniciando sistema de lembrar login...");
            
            const isAndroidApp = typeof Android !== 'undefined';
            console.log("ðŸ“± Ambiente:", isAndroidApp ? "Android APK" : "Navegador");
            
            let savedLogin = null;
            let source = '';
            
            // PRIMEIRO: Tenta do Android
            if (isAndroidApp) {
                try {
                    console.log("ðŸ“± Tentando carregar do Android...");
                    const androidData = Android.carregarLogin();
                    console.log("ðŸ“± Resposta do Android:", androidData);
                    
                    if (androidData && androidData !== "{}" && androidData !== "null" && androidData !== "") {
                        savedLogin = JSON.parse(androidData);
                        source = 'Android';
                        console.log('âœ… Credenciais carregadas do Android');
                    }
                } catch (error) {
                    console.log('âŒ Falha no Android, tentando fallback...', error);
                }
            }
            
            // SEGUNDO: Fallback para localStorage
            if (!savedLogin) {
                try {
                    const localData = localStorage.getItem('nfe_login_credentials');
                    if (localData) {
                        savedLogin = JSON.parse(localData);
                        source = 'LocalStorage';
                        console.log('âœ… Credenciais carregadas do localStorage');
                    }
                } catch (error) {
                    console.log('âŒ Erro no localStorage:', error);
                }
            }
            
            // TERCEIRO: Se encontrou credenciais, preenche os campos
            if (savedLogin && savedLogin.username && savedLogin.password) {
                document.getElementById('username').value = savedLogin.username;
                document.getElementById('password').value = savedLogin.password;
                console.log(`âœ… Campos preenchidos (Fonte: ${source})`);
                
            
                
            }
        }

        /**
         * âœ… SALVAR CREDENCIAIS - VERSÃƒO ROBUSTA
         */
        function saveLoginCredentials(username, password) {
            const loginData = {
                username: username,
                password: password,
                timestamp: Date.now(),
                source: 'login_success'
            };
            
            console.log("ðŸ’¾ Salvando credenciais para:", username);
            
            const isAndroidApp = typeof Android !== 'undefined';
            
            // Salva no Android
            if (isAndroidApp) {
                try {
                    Android.salvarLogin(JSON.stringify(loginData));
                    console.log('âœ… Salvo no Android');
                } catch (error) {
                    console.log('âŒ Erro ao salvar no Android:', error);
                }
            }
            
            // Salva no localStorage (sempre)
            try {
                localStorage.setItem('nfe_login_credentials', JSON.stringify(loginData));
                console.log('âœ… Salvo no localStorage');
            } catch (error) {
                console.log('âŒ Erro ao salvar no localStorage:', error);
            }
            
        }

        /**
         * âœ… LIMPAR CREDENCIAIS SALVAS (APENAS QUANDO EXPLICITAMENTE SOLICITADO)
         */
        function clearLoginCredentials() {
            const isAndroidApp = typeof Android !== 'undefined';
            
            if (isAndroidApp) {
                try {
                    Android.salvarLogin("", "");
                    console.log('âœ… Credenciais limpas no Android');
                } catch (error) {
                    console.log('âŒ Erro ao limpar credenciais no Android:', error);
                }
            }
            
            try {
                localStorage.removeItem('nfe_login_credentials');
                console.log('âœ… Credenciais limpas no navegador');
            } catch (error) {
                console.log('âŒ Erro ao limpar credenciais no navegador:', error);
            }
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            showNotification('Credenciais removidas com sucesso', 'info');
        }


        /**
         * Realiza o login
         */
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('Preencha usuÃ¡rio e senha', 'error');
                return;
            }

            showNotification('Autenticando...', 'loading');

            try {
                const response = await fetch(`${BACKEND_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                hideNotification();

                if (result.success) {
                    currentUser = result.user;
                    showMainSystem();
                    showNotification(`Bem-vindo, ${username}!`, 'success');
                    
                    // âœ… SALVA AS CREDENCIAIS APÃ“S LOGIN BEM-SUCEDIDO
                    saveLoginCredentials(username, password);
                    
                } else {
                    showNotification(result.message || 'Erro ao fazer login', 'error');
                }

            } catch (error) {
                hideNotification();
                console.error('Erro no login:', error);
                
                if (error.message.includes('401')) {
                    showNotification('UsuÃ¡rio ou senha incorretos', 'error');
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    showNotification('Erro de conexÃ£o com o servidor', 'error');
                } else {
                    showNotification('Erro ao fazer login', 'error');
                }
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/check-auth`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    return false;
                }

                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    return true;
                }
                return false;
                
            } catch (error) {
                console.error('Erro ao verificar autenticaÃ§Ã£o:', error);
                return false;
            }
        }

        /**
         * âœ… LOGOUT CORRIGIDO - NÃƒO LIMPA CREDENCIAIS SALVAS
         */
        async function logout() {
            try {
                await fetch(`${BACKEND_URL}/api/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Erro no logout:', error);
            } finally {
                // âœ… MANTÃ‰M AS CREDENCIAIS SALVAS - NÃƒO LIMPA!
                currentUser = null;
                document.getElementById('main-system').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                // âœ… NÃƒO LIMPA OS CAMPOS - DEIXA AS CREDENCIAIS SALVAS VISÃVEIS
                // Os campos JÃ devem estar preenchidos pelo setupLoginRemember()
                
                showNotification('Logout realizado. Use o botÃ£o "Entrar" para acessar novamente.', 'success', 3000);
                
                // âœ… FORÃ‡A RECARREGAMENTO DAS CREDENCIAIS (para garantir)
                setTimeout(() => {
                    setupLoginRemember();
                }, 500);
            }
        }

        /**
         * Mostra o sistema principal
         */
        function showMainSystem() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-system').classList.remove('hidden');
            
            initializeSystem();
        }

        /**
         * Inicializa o sistema apÃ³s login
         */
        function initializeSystem() {
            switchTab('NOTA FISCAL');
            setupBeforeUnloadListener();
            startCacheChangeMonitor();
        }

        // Interceptador para verificar autenticaÃ§Ã£o em todas as requisiÃ§Ãµes
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                
                // Se for 401 em uma rota protegida E usuÃ¡rio estÃ¡ logado
                if (response.status === 401 && currentUser) {
                    const url = args[0] || '';
                    
                    // Ignora rotas pÃºblicas
                    if (url.includes('/api/login') || url.includes('/api/check-auth')) {
                        return response;
                    }
                    
                    console.log('ðŸ” SessÃ£o expirada para rota protegida:', url);
                    
                    // Verifica novamente com check-auth para confirmar
                    const authCheck = await fetch(`${BACKEND_URL}/api/check-auth`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (authCheck.status === 401) {
                        console.log('âœ… ConfirmaÃ§Ã£o: sessÃ£o realmente expirada');
                        showNotification('SessÃ£o expirada. FaÃ§a login novamente.', 'error');
                        
                        // Pequeno delay antes do logout
                        setTimeout(() => {
                            if (currentUser) {
                                logout();
                            }
                        }, 2000);
                    } else {
                        console.log('âŒ Falso positivo - sessÃ£o ainda vÃ¡lida');
                        // NÃ£o faz logout - pode ser um erro especÃ­fico da rota
                    }
                }
                
                return response;
            } catch (error) {
                console.error('Erro no interceptador fetch:', error);
                throw error;
            }
        };

        /**
         * âœ… INICIALIZAÃ‡ÃƒO CORRIGIDA
         */
        async function initializeApp() {
            console.log("ðŸš€ INICIALIZANDO APLICATIVO...");
            
            try {
                // âœ… CONFIGURA LEMBRAR LOGIN
                setTimeout(() => {
                    setupLoginRemember();
                }, 800);
                
                // âœ… VERIFICA AUTENTICAÃ‡ÃƒO EXISTENTE
                const isAuthenticated = await checkAuth();
                
                if (isAuthenticated) {
                    console.log("âœ… UsuÃ¡rio jÃ¡ autenticado, mostrando sistema...");
                    showMainSystem();
                    showNotification(`Bem-vindo de volta, ${currentUser}!`, 'success');
                } else {
                    console.log("ðŸ” UsuÃ¡rio nÃ£o autenticado, mostrando tela de login");
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('main-system').classList.add('hidden');
                }
                
            } catch (error) {
                console.error('ðŸ’¥ Erro crÃ­tico na inicializaÃ§Ã£o:', error);
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-system').classList.add('hidden');
            }
        }

        // =========================================================================
        // FIM DO SISTEMA DE AUTENTICAÃ‡ÃƒO
        // =========================================================================

        // --- Sistema de Cache para Contagem Loja ---
        const CACHE_KEY = 'contagem_loja_cache';
        const CACHE_DURATION = 3 * 60 * 60 * 1000; // 3 horas em milissegundos
        const BATCH_SIZE = 50; // Atualizar a cada 50 cÃ©lulas
        let pendingUpdates = new Map(); // Armazena as atualizaÃ§Ãµes pendentes
        let editCount = 0; // Contador de ediÃ§Ãµes
        
        // --- VariÃ¡veis para Contadores ---
        let currentContador = 'CONTAGEM LOJA'; // Contador atual (padrÃ£o: Contagem Loja/Contador 1)
        
        // --- Cache de dados da Nota Fiscal para busca instantÃ¢nea ---
        let notaFiscalData = null;
        let codigoBarrasIndex = {}; // Ãndice para busca rÃ¡pida: {codigo: descricao}

        // --- SISTEMA DE SOM OTIMIZADO ---
        let lastSoundTime = 0;
        const SOUND_COOLDOWN = 100; // 100ms entre sons
        let soundCount = 0;

        // --- VARIÃVEL PARA CONTROLE DE TIMING ---
        let lastInputTime = 0;
        const INPUT_DEBOUNCE = 150; // ms para esperar pelo Enter apÃ³s digitaÃ§Ã£o

        // --- VariÃ¡veis para Auto-Save por MudanÃ§as no Cache ---
        let cacheChangeTimer;
        const CACHE_CHANGE_TIMEOUT = 5 * 60 * 1000; // 5 minutos em milissegundos
        let lastCacheCount = 0; // Ãšltima contagem conhecida do cache

        // --- Gerenciamento de Abas ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentStack = document.getElementById('content-stack');

        // --- Cache para ajustes da ConferÃªncia ---
        const CONFERENCE_ADJUSTMENTS_KEY = 'conference_adjustments_cache';
        let conferenceAdjustments = {};

        tabButtons.forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });

        /**
         * âš¡ FUNÃ‡ÃƒO: Envia automaticamente o cache quando sair da aba Contagem
         */
        function autoSaveContagemOnTabChange() {
            const currentTab = document.querySelector('.tab-button.border-indigo-600')?.dataset.tab;
            const isLeavingContagem = currentTab === 'CONTAGEM LOJA';
            
            if (isLeavingContagem) {
                const cacheKey = `${CACHE_KEY}_${currentContador}`;
                const cachedData = loadFromCache(cacheKey);
                
                const hasData = Object.keys(cachedData).filter(key => key.startsWith('A')).length > 0;
                
                if (hasData) {
                    console.log('ðŸ”„ Auto-save: Saindo da Contagem Loja, enviando dados...');
                    showNotification('Salvando dados da contagem...', 'loading', 2000);
                    
                    processBatchUpdate();
                }
            }
        }

        /**
         * âš¡ AUTO-SAVE quando a pÃ¡gina for fechada/atualizada
         */
        function setupBeforeUnloadListener() {
            window.addEventListener('beforeunload', function (e) {
                const currentTab = document.querySelector('.tab-button.border-indigo-600')?.dataset.tab;
                
                if (currentTab === 'CONTAGEM LOJA') {
                    const cacheKey = `${CACHE_KEY}_${currentContador}`;
                    const cachedData = loadFromCache(cacheKey);
                    const hasData = Object.keys(cachedData).filter(key => key.startsWith('A')).length > 0;
                    
                    if (hasData) {
                        console.log('ðŸ”„ Tentando salvar antes de sair...');
                        
                        fetch(`${BACKEND_URL}/api/batch-update-sheet`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ 
                                sheet_name: currentContador,
                                updates: Object.entries(cachedData).map(([range, value]) => ({
                                    range: range,
                                    value: value
                                }))
                            }),
                            keepalive: true
                        }).catch(err => console.log('Auto-save falhou:', err));
                    }
                }
            });
        }

        /**
         * ðŸ†• VERIFICA se houve mudanÃ§a no cache e reseta o timer se necessÃ¡rio
         */
        function checkCacheChange() {
            const currentTab = document.querySelector('.tab-button.border-indigo-600')?.dataset.tab;
            
            if (currentTab !== 'CONTAGEM LOJA') {
                return false;
            }

            const cacheKey = `${CACHE_KEY}_${currentContador}`;
            const cachedData = loadFromCache(cacheKey);
            const currentCacheCount = Object.keys(cachedData).filter(key => key.startsWith('A')).length;
            
            console.log(`ðŸ” Monitor Cache: ${lastCacheCount} -> ${currentCacheCount}`);
            
            if (currentCacheCount !== lastCacheCount) {
                console.log(`ðŸ”„ MudanÃ§a detectada no cache! Resetando timer de 5 minutos.`);
                lastCacheCount = currentCacheCount;
                resetCacheChangeTimer();
                return true;
            }
            
            return false;
        }

        /**
         * ðŸ†• Reseta o timer de mudanÃ§as no cache
         */
        function resetCacheChangeTimer() {
            if (cacheChangeTimer) {
                clearTimeout(cacheChangeTimer);
            }
            
            cacheChangeTimer = setTimeout(() => {
                checkAndAutoSaveByCache();
            }, CACHE_CHANGE_TIMEOUT);
            
            console.log(`â° Timer de cache resetado: 5 minutos`);
        }

        /**
         * ðŸ†• Verifica e executa auto-save baseado em mudanÃ§as no cache
         */
        function checkAndAutoSaveByCache() {
            const currentTab = document.querySelector('.tab-button.border-indigo-600')?.dataset.tab;
            
            if (currentTab === 'CONTAGEM LOJA') {
                const cacheKey = `${CACHE_KEY}_${currentContador}`;
                const cachedData = loadFromCache(cacheKey);
                const hasData = Object.keys(cachedData).filter(key => key.startsWith('A')).length > 0;
                
                if (hasData) {
                    console.log('ðŸ”„ Auto-save por inatividade de cache: 5 minutos sem alteraÃ§Ãµes');
                    showNotification('Salvando dados automaticamente...', 'loading', 3000);
                    processBatchUpdate();
                }
            }
            
            startCacheChangeMonitor();
        }

        /**
         * ðŸ†• Inicia o monitor de mudanÃ§as no cache
         */
        function startCacheChangeMonitor() {
            if (cacheChangeTimer) {
                clearTimeout(cacheChangeTimer);
            }
            
            const cacheKey = `${CACHE_KEY}_${currentContador}`;
            const cachedData = loadFromCache(cacheKey);
            lastCacheCount = Object.keys(cachedData).filter(key => key.startsWith('A')).length;
            
            console.log(`ðŸ” Iniciando monitor de cache. Contagem inicial: ${lastCacheCount}`);
            
            setInterval(() => {
                checkCacheChange();
            }, 30000);
            
            resetCacheChangeTimer();
        }

        /**
         * Altera a aba ativa e carrega o conteÃºdo.
         * AGORA COM CONTROLE DE MONITOR DE CACHE
         */
        function switchTab(sheetName) {
    // âœ… SALVA OS DADOS DA CONTAGEM ANTES DE MUDAR PARA CONFERÃŠNCIA
    const currentTab = document.querySelector('.tab-button.border-indigo-600')?.dataset.tab;
    
    if (currentTab === 'CONTAGEM LOJA' && sheetName === 'CONFERENCIA') {
        console.log('ðŸ”„ Saindo da Contagem Loja para ConferÃªncia - Salvando dados...');
        
        const cacheKey = `${CACHE_KEY}_${currentContador}`;
        const cachedData = loadFromCache(cacheKey);
        const hasData = Object.keys(cachedData).filter(key => key.startsWith('A')).length > 0;
        
        if (hasData) {
            // âœ… SALVA OS DADOS E SÃ“ DEPOIS MUDA PARA CONFERÃŠNCIA
            showNotification('Salvando dados da contagem antes de carregar conferÃªncia...', 'loading');
            
            processBatchUpdate().then(() => {
                // âœ… DEPOIS DE SALVAR, MUDA PARA CONFERÃŠNCIA
                console.log('âœ… Dados salvos, mudando para ConferÃªncia...');
                realizarMudancaParaConferencia(sheetName);
            }).catch((error) => {
                // âœ… SE DER ERRO, MUDA MESMO ASSIM MAS AVISA
                console.error('âŒ Erro ao salvar, mas mudando para ConferÃªncia:', error);
                showNotification('Erro ao salvar dados, carregando conferÃªncia...', 'warning', 2000);
                realizarMudancaParaConferencia(sheetName);
            });

			    setTimeout(() => {
        verificarModoDesktopAba();
    }, 300);
            
            return; // âš ï¸ IMPORTANTE: para a execuÃ§Ã£o aqui
        }
    }
    
    // âœ… SE NÃƒO FOR PARA CONFERÃŠNCIA OU NÃƒO HOUVER DADOS, MUDA NORMALMENTE
    realizarMudancaNormal(sheetName);
}

/**
 * âœ… FUNÃ‡ÃƒO AUXILIAR: MudanÃ§a normal para qualquer aba
 */
function realizarMudancaNormal(sheetName) {
    autoSaveContagemOnTabChange();
    
    const currentTab = document.querySelector('.tab-button.border-indigo-600')?.dataset.tab;
    if (currentTab === 'CONTAGEM LOJA' && sheetName !== 'CONTAGEM LOJA') {
        if (cacheChangeTimer) {
            clearTimeout(cacheChangeTimer);
        }
    }
    
    if (sheetName === 'CONTAGEM LOJA') {
        startCacheChangeMonitor();
    }

    tabButtons.forEach(btn => {
        if (btn.dataset.tab === sheetName) {
            btn.classList.add('border-indigo-600', 'text-indigo-600');
            btn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
        } else {
            btn.classList.remove('border-indigo-600', 'text-indigo-600');
            btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
        }
    });

    contentStack.innerHTML = `<div class="text-center py-10 text-gray-500">Carregando dados de ${sheetName}...</div>`;
    
    if (sheetName === "NOTA FISCAL") {
        contentStack.innerHTML = renderNotaFiscalLayout();
    } else if (sheetName === "CONTAGEM LOJA") {
        contentStack.innerHTML = renderContagemLojaLayout();
        currentContador = 'CONTAGEM LOJA';
    } else if (sheetName === "CONFERENCIA") {
        contentStack.innerHTML = renderConferenciaLayout();
    }
    
    loadTabContent(sheetName);
    clearSearch(); // Limpa busca ao mudar de aba
}

/**
 * âœ… FUNÃ‡ÃƒO AUXILIAR: MudanÃ§a ESPECÃFICA para ConferÃªncia (apÃ³s salvamento)
 */
function realizarMudancaParaConferencia(sheetName) {
    // âœ… ATUALIZA A ABA VISUALMENTE
    tabButtons.forEach(btn => {
        if (btn.dataset.tab === sheetName) {
            btn.classList.add('border-indigo-600', 'text-indigo-600');
            btn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
        } else {
            btn.classList.remove('border-indigo-600', 'text-indigo-600');
            btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
        }
    });

    contentStack.innerHTML = `<div class="text-center py-10 text-gray-500">Carregando dados de ${sheetName}...</div>`;
    contentStack.innerHTML = renderConferenciaLayout();
    
    // âœ… CARREGA A CONFERÃŠNCIA COM UM PEQUENO DELAY PARA DADOS ATUALIZADOS
    setTimeout(() => {
        loadTabContent("CONFERENCIA");
        
        // âœ… FORÃ‡A UMA ATUALIZAÃ‡ÃƒO EXTRA APÃ“S 1.5 SEGUNDOS
        setTimeout(() => {
            console.log('ðŸ”„ AtualizaÃ§Ã£o extra da ConferÃªncia para dados recentes...');
            loadTabContent("CONFERENCIA");
        }, 1500);
    }, 500);
    
    clearSearch();
}

        // ÃCONES
        const documentIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
        const printerIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m-1-5a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2zm-4 4h4v2a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2h4z" /></svg>`;


        /**
         * Retorna o HTML completo da aba NOTA FISCAL (botÃµes + placeholder da tabela).
         */
        function renderNotaFiscalLayout() {
            return `
                <div class="flex flex-wrap gap-3 pb-4 mb-4 border-b border-gray-200 print-hidden">
                    <label for="xml-file-upload" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 cursor-pointer text-sm font-medium border border-gray-300">
                        <span class="text-orange-600">${documentIcon}</span>
                        <span>Importar Nota Fiscal (XML)</span>
                    </label>
                    <input type="file" id="xml-file-upload" accept=".xml" class="hidden" onchange="handleFileUploadChange(event)">
                    
                    <button id="show-paste-modal" onclick="showPasteModal()" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 text-sm font-medium border border-gray-300">
                        <span class="text-yellow-600">${documentIcon}</span>
                        <span>Importar por Chave de Acesso</span>
                    </button>

					  <!-- BOTÃƒO MODO DESKTOP - APENAS MOBILE -->
                <button onclick="alternarModoDesktop()" id="desktop-mode-button-conferencia" class="btn-desktop-mode mobile-only">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span id="desktop-mode-text-conferencia">Modo Desktop</span>
                </button>
					
            <!--
                <button onclick="toggleScrollMode('CONFERENCIA')" id="scroll-button-conferencia" class="flex md:hidden items-center space-x-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hover:bg-indigo-200 transition duration-150 text-sm font-medium border border-indigo-300">
                    <span>Modo Scroll</span>
                </button>
                -->

                    <button onclick="confirmClearAllSheets()" class="flex items-center space-x-2 px-4 py-2 bg-red-50 text-red-700 rounded-lg shadow-sm hover:bg-red-100 transition duration-150 text-sm font-medium border border-red-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-2 0v6a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>
                        <span>Apagar Dados</span>
                    </button>
                </div>
                <div id="dynamic-table-content">
                    <p class="text-center text-gray-400 py-10">Use o botÃ£o de importaÃ§Ã£o (XML) para carregar dados nesta aba.</p>
                </div>
            `;
        }

        /**
         * Retorna o HTML completo da aba CONTAGEM LOJA com mini-menu de contadores.
         */
        function renderContagemLojaLayout() {
            return `
                <div id="contagem-loja-content">
                    <!-- Mini-menu de Contadores -->
                    <div class="flex border-b border-gray-200 mb-4 print-hidden">
                        <button data-contador="CONTAGEM LOJA" class="contador-button px-4 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors duration-150">Contador 1</button>
                        <button data-contador="CONTADOR 2" class="contador-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">Contador 2</button>
                        <button data-contador="CONTADOR 3" class="contador-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">Contador 3</button>
                        <button data-contador="CONTADOR 4" class="contador-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">Contador 4</button>
                        <button data-contador="CONTADOR 5" class="contador-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">Contador 5</button>
                    </div>

                    <div class="flex flex-wrap gap-3 pb-4 mb-4 border-b border-gray-200 print-hidden">
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="font-semibold text-yellow-800 text-lg">Escanear abaixo</p>
                            <p class="text-yellow-600 text-sm mt-1">Dados salvos localmente (atualizaÃ§Ã£o em lote)</p>
                        </div>
                        <button onclick="forceBatchUpdate()" class="flex items-center space-x-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg shadow-sm hover:bg-blue-200 transition duration-150 text-sm font-medium border border-blue-300">
                            <span>ForÃ§ar Envio</span>
                            <span id="pending-count" class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">0</span>
                        </button>
                    </div>
                    <div id="dynamic-table-content-contagem">
                        <p class="text-center text-gray-400 py-10">Carregando dados...</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Retorna o HTML completo da aba CONFERENCIA (com botÃ£o de impressÃ£o e modo scroll).
         */
        function renderConferenciaLayout() {
    return `
        <div id="conferencia-content">
            <div class="flex flex-wrap gap-3 pb-4 mb-4 border-b border-gray-200 print-hidden">
                <button onclick="printConferencia()" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 text-sm font-medium border border-gray-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m-1-5a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2zm-4 4h4v2a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2h4z" />
    </svg>
    <span>Imprimir ou salvar em PDF</span>
</button>

<!-- âœ… BOTÃƒO EXPORTAR EXCEL -->
<button onclick="exportarParaExcel()" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 text-sm font-medium border border-gray-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <span>Exportar Excel</span>
</button>
                
                <!-- âœ… BOTÃƒO 1: MOSTRAR APENAS DIVERGÃŠNCIAS -->
                <button onclick="filtrarDivergencias()" id="divergencias-button" class="flex items-center space-x-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg shadow-sm hover:bg-red-200 transition duration-150 text-sm font-medium border border-red-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    <span>Mostrar apenas divergÃªncias</span>
                </button>
                
                <!-- âœ… BOTÃƒO 2: INTEGRAR NOTA -->
<button onclick="abrirIntegracaoNota()" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 text-sm font-medium border border-gray-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
    </svg>
    <span>Integrar nota</span>
</button>

<!-- âœ… BOTÃƒO ENVIAR EMAIL -->
<button onclick="abrirOpcoesEmail()" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 text-sm font-medium border border-gray-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
    </svg>
    <span>Enviar por Email</span>
</button>
                  <!-- BOTÃƒO MODO DESKTOP - APENAS MOBILE -->
                <button onclick="alternarModoDesktop()" id="desktop-mode-button-conferencia" class="btn-desktop-mode mobile-only">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span id="desktop-mode-text-conferencia">Modo Desktop</span>
                </button>

                <!--
                <button onclick="toggleScrollMode('CONFERENCIA')" id="scroll-button-conferencia" class="flex md:hidden items-center space-x-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hover:bg-indigo-200 transition duration-150 text-sm font-medium border border-indigo-300">
                    <span>Modo Scroll</span>
                </button>
                -->
            </div>
            <div id="dynamic-table-content-conferencia">
                <p class="text-center text-gray-400 py-10">Carregando dados...</p>
            </div>
        </div>
    `;
}

        /**
         * Abre a caixa de diÃ¡logo de impressÃ£o do navegador com estilos A4.
         */
        function printConferencia() {
            window.print();
        }

        /**
         * Renderiza a tabela da Contagem Loja com 3000 linhas prÃ©-renderizadas e 2 colunas.
         */
        function renderContagemTableFixedRows(data, headers) {
            const fixedRows = 3000;
            
            const cacheKey = `${CACHE_KEY}_${currentContador}`;
            const cachedData = loadFromCache(cacheKey);
            
            const existingData = (data.length > 0 && headers.length > 0 && String(data[0][0]) === headers[0]) 
                                 ? data.slice(1) 
                                 : data;

            let html = `
                <div class="rounded-lg border border-gray-200 overflow-x-auto shadow-sm">
                    <table class="mock-table w-full text-sm" id="contagem-table">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th>CÃ³digo de Barras</th>
                                <th>DescriÃ§Ã£o</th>
                            </tr>
                        </thead>
                        <tbody>`;

            for (let rowIndex = 0; rowIndex < fixedRows; rowIndex++) {
                const sheetRowIndex = rowIndex + 1;
                const sheetRangeA = `A${sheetRowIndex}`;
                const sheetRangeC = `C${sheetRowIndex}`;
                
                let cellValueA = '';
                if (cachedData[sheetRangeA] !== undefined) {
                    cellValueA = cachedData[sheetRangeA];
                } else if (existingData[rowIndex] && existingData[rowIndex][0] !== undefined) {
                    cellValueA = existingData[rowIndex][0];
                }
                
                let cellValueC = '';
                if (cachedData[sheetRangeC] !== undefined) {
                    cellValueC = cachedData[sheetRangeC];
                } else if (existingData[rowIndex] && existingData[rowIndex][2] !== undefined) {
                    cellValueC = existingData[rowIndex][2];
                }

                const hasRedBackground = cellValueA !== '' && cellValueC === '';
                const rowClass = hasRedBackground ? 'bg-red-50' : '';

                const editAttributes = `contenteditable="true"
                                        onblur="handleContagemCellEdit(this, '${sheetRangeA}', '${currentContador}')"
                                        onkeydown="handleContagemKeyPress(event, '${sheetRangeA}', '${currentContador}')"
                                        oninput="handleContagemCellInput(this)"
                                        data-original-value="${cellValueA}"
                                        data-sheet-range="${sheetRangeA}"`;
                
                const cellClassesA = 'cursor-text hover:bg-indigo-50/50 focus:bg-indigo-100 border border-transparent focus:border-indigo-400 transition expand-mode-cell';

                html += `<tr data-row-index="${sheetRowIndex}" class="${rowClass}">
                            <td ${editAttributes} onkeydown="handleContagemCellKeydown(event, this)" class="${cellClassesA}">${cellValueA}</td>
                            <td class="expand-mode-cell descricao-cell" data-row-index="${sheetRowIndex}" data-sheet-range="${sheetRangeC}">${cellValueC}</td>
                         </tr>`;
            }

            html += `</tbody></table></div>`;
            return html;
        }


    function renderTable(sheetName, data, headers) {
    
    if (!data || data.length === 0) {
        return `<p class="text-center text-gray-500 py-10">Nenhum dado encontrado no Google Sheets para esta aba.</p>`;
    }

    const isConferencia = sheetName === "CONFERENCIA";
    const isStatusEditable = isConferencia;
    
    let tableID = '';
    if (sheetName === 'CONFERENCIA') {
        tableID = 'conferencia-table';
    } else if (sheetName === 'NOTA FISCAL') {
        tableID = 'notafiscal-table';
    }

    let html = `
        <div class="rounded-lg border border-gray-200 overflow-x-auto shadow-sm">
            <table class="mock-table w-full text-sm" id="${tableID}">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>`;
    
    headers.forEach(h => {
        html += `<th class="w-auto whitespace-nowrap">${h}</th>`;
    });
    html += `</tr></thead><tbody>`;

    let dataRows = data;
    
    if (data.length > 0 && headers.length > 0 && String(data[0][0]) === headers[0]) {
        dataRows = data.slice(1);
    }

    dataRows.forEach((row, rowIndex) => {
        const isRowEmpty = row.length === 0 || row.every(cell => !cell || String(cell).trim() === '');
        if (isRowEmpty) return; 

        const sheetRowIndex = (data[0][0] === headers[0] ? rowIndex + 2 : rowIndex + 1);
        
        // âœ… VERIFICA SE Ã‰ UMA LINHA DE INFORMAÃ‡Ã•ES DA NOTA FISCAL
        const isInfoRow = row.some(cell => 
            cell && String(cell).includes('Data:') && 
            String(cell).includes('Pedido:') && 
            String(cell).includes('Chave:')
        );
        
        const rowClass = isInfoRow ? 'bg-blue-200' : '';
        
        // âœ… APLICA AJUSTES DO CACHE SE EXISTIREM
        const adjustments = loadConferenceAdjustments();
        const adjustedRow = [...row]; // Cria uma cÃ³pia da linha
        
        // Aplica ajustes da coluna D (Contagem Loja)
        if (adjustments[`D${sheetRowIndex}`] !== undefined) {
            adjustedRow[3] = adjustments[`D${sheetRowIndex}`]; // Coluna D Ã© Ã­ndice 3
        }
        
        // Aplica ajustes da coluna E (DiferenÃ§a)
        if (adjustments[`E${sheetRowIndex}`] !== undefined) {
            adjustedRow[4] = adjustments[`E${sheetRowIndex}`]; // Coluna E Ã© Ã­ndice 4
        }
        
        html += `<tr data-row-index="${sheetRowIndex}" class="${rowClass}">`;
                    
        for (let i = 0; i < headers.length; i++) {
            const cellValue = adjustedRow[i] !== undefined ? adjustedRow[i] : ''; // âœ… USA adjustedRow
            
            const sheetCol = String.fromCharCode(65 + i);
            const sheetRange = `${sheetCol}${sheetRowIndex}`;

            let editAttributes = '';
            let cellClasses = '';

            const isCellEditable = (isStatusEditable && i === 6); // Agora coluna 6 (Danos/Defeito e Obs)

            if (isCellEditable) {
                editAttributes = `contenteditable="true"
                                 onblur="handleDanosDefeitoEdit(this, '${sheetRange}', '${sheetName}')"
                                 data-original-value="${cellValue}"
                                 data-sheet-range="${sheetRange}"`;
                
                // âœ… REMOVIDAS AS CLASSES QUE CRIAM BORDA - APENAS cursor-text
                cellClasses = 'cursor-text';
            }
            
            let columnsToExpand = [];
            if (isConferencia) {
                 columnsToExpand = [1, 2, 3, 4, 5, 6, 7]; // Agora 7 colunas
            } else if (sheetName === "NOTA FISCAL") {
                 columnsToExpand = [1, 2, 3, 4];
            }
            
            if (columnsToExpand.includes(i + 1)) { 
                 cellClasses += ' expand-mode-cell'; 
            }

            // âœ… ADICIONAR BOTÃƒO âœ“ NA COLUNA "AJUSTAR" (Ã­ndice 5)
            if (isConferencia && i === 5) { // Coluna "Corrigir"
                const diferencaValue = adjustedRow[4] !== undefined ? parseFloat(String(adjustedRow[4]).replace(',', '.')) : 0;
                const quantidadeNF = adjustedRow[2] !== undefined ? parseFloat(String(adjustedRow[2]).replace(',', '.')) : 0;
                
                if (!isNaN(diferencaValue) && diferencaValue !== 0 && !isNaN(quantidadeNF)) {
                   html += `<td class="text-center">
            <button onclick="igualarContagem('${sheetRowIndex}', ${quantidadeNF})" 
                    class="w-8 h-8 bg-transparent text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150 text-sm font-medium border border-transparent hover:border-gray-300 flex items-center justify-center mx-auto">
                â†º
            </button>
         </td>`;
                } else {
                    html += `<td></td>`;
                }
            } 
            // âœ… COLUNA DANOS/DEFEITO - SEM BORDAS
           else if (isConferencia && i === 6) { // Coluna "Danos/Defeito e Obs"
    html += `
        <td class="relative">
            <div class="flex items-center gap-1">
                <div ${editAttributes} 
                     onkeydown="handleDanosEnterKey(event)"
                     class="flex-1 min-h-[24px] descricao-danos">
                    ${cellValue}
                </div>
                <button onclick="mostrarOpcoesDanos(this, '${sheetRange}')" 
                        class="opcao-danos-btn px-1 py-0 text-gray-500 hover:text-gray-700 transition text-lg font-normal">
                    +
                </button>
            </div>
        </td>
    `;
}
            else {
                html += `<td ${editAttributes} class="${cellClasses}">${cellValue}</td>`;
            }
        }
        html += `</tr>`;
    });
    
    html += `</tbody></table></div>`;
    return html;
}

        /**
         * Gerencia a busca de dados e a renderizaÃ§Ã£o do conteÃºdo da aba.
         */
        async function loadTabContent(sheetName) {
    const sheetToLoad = (sheetName === "CONTAGEM LOJA") ? currentContador : sheetName;
    const data = await fetchSheetData(sheetToLoad);

    let targetElementId = 'dynamic-table-content';
    let headers = [];

    if (sheetName === "NOTA FISCAL") {
        headers = ["DescriÃ§Ã£o", "Quantidade", "CÃ³digo de Barras", "Item"];
        targetElementId = 'dynamic-table-content';
        const targetElement = document.getElementById(targetElementId);
        if (targetElement) {
            targetElement.innerHTML = renderTable(sheetName, data, headers);
            updateNotaFiscalCache(data);
        }

    } else if (sheetName === "CONTAGEM LOJA") {
        headers = ["CÃ³digo de Barras", "DescriÃ§Ã£o"]; 
        targetElementId = 'dynamic-table-content-contagem';
        
        setTimeout(() => {
            const contadorButtons = document.querySelectorAll('.contador-button');
            contadorButtons.forEach(button => {
                button.addEventListener('click', function() {
                    switchContador(this.getAttribute('data-contador'));
                });
            });
        }, 100);
        
        if (!notaFiscalData) {
            await loadNotaFiscalDataForCache();
        }
        
        const targetElement = document.getElementById(targetElementId);
        if (targetElement) {
            targetElement.innerHTML = renderContagemTableFixedRows(data, headers);
            
            updatePendingCount();
            
            startCacheChangeMonitor();
            
            setTimeout(() => {
                requestAnimationFrame(focusNextEmptyContagemCell);
            }, 100); 
        }

    } else if (sheetName === "CONFERENCIA") {
    headers = ["CÃ³digo de Barras", "DescriÃ§Ã£o do Produto", "Quantidade NF", "Contagem Loja", "DiferenÃ§a", "Corrigir", "Danos/Defeito e Obs"]; 
    targetElementId = 'dynamic-table-content-conferencia';
    
    const targetElement = document.getElementById(targetElementId);
    if (targetElement) {
        // âœ… BUSCA AS INFORMAÃ‡Ã•ES DAS NOTAS FISCAIS
        const notasFiscaisInfo = await getNotasFiscaisInfo();
        
        // âœ… RENDERIZA APENAS AS INFORMAÃ‡Ã•ES DAS NOTAS FISCAIS ACIMA DA TABELA
        const notasInfoHtml = renderNotasFiscaisInfo(notasFiscaisInfo);
        targetElement.innerHTML = notasInfoHtml + renderTable(sheetName, data, headers);
        
        // âœ… ADICIONE ESTA LINHA PARA APLICAR OS ESTILOS:
        setTimeout(() => {
            aplicarConferenciaStyles(headers.length);
        }, 100);
    }
}
}

/**
 * âœ… FUNÃ‡ÃƒO: Busca informaÃ§Ãµes das notas fiscais da aba NOTA FISCAL
 */
async function getNotasFiscaisInfo() {
    try {
        const notaFiscalData = await fetchSheetData("NOTA FISCAL");
        if (!notaFiscalData || !Array.isArray(notaFiscalData)) {
            return [];
        }

        const notasInfo = [];
        
        // Procura por linhas que contÃªm informaÃ§Ãµes de notas fiscais
        for (let row of notaFiscalData) {
            if (row && Array.isArray(row) && row.length > 0) {
                const firstCell = String(row[0]).trim();
                
                // Verifica se Ã© uma linha de informaÃ§Ã£o de nota fiscal
                if (firstCell.includes('Data:') && firstCell.includes('Pedido:') && firstCell.includes('Chave:')) {
                    // âœ… SUBSTITUI OS NOMES PARA O FORMATO SOLICITADO
                    let formattedInfo = firstCell;
                    
                    // Substitui "NF:" por "Nfe:"
                    formattedInfo = formattedInfo.replace(/NF:/g, 'Nfe:');
                    
                    // Substitui "Data:" por "Data de emissÃ£o:"
                    formattedInfo = formattedInfo.replace(/Data:/g, 'Data de emissÃ£o:');
                    
                    // Substitui "Pedido:" por "Pedido Capta:"
                    formattedInfo = formattedInfo.replace(/Pedido:/g, 'Pedido Capta:');
                    
                    // MantÃ©m "Chave:" (jÃ¡ estÃ¡ correto)
                    
                    notasInfo.push(formattedInfo);
                }
            }
        }
        
        console.log(`âœ… Encontradas ${notasInfo.length} notas fiscais na aba NOTA FISCAL`);
        return notasInfo;
        
    } catch (error) {
                console.error("Erro ao buscar informaÃ§Ãµes das notas fiscais:", error);
        return [];
    }
}

/**
 * âœ… FUNÃ‡ÃƒO SIMPLES: Renderiza informaÃ§Ãµes das notas fiscais (igual ao index original)
 */
function renderNotasFiscaisInfo(notasFiscaisInfo) {
    if (!notasFiscaisInfo || notasFiscaisInfo.length === 0) {
        return '<div class="mb-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-600">Nenhuma nota fiscal encontrada</div>';
    }

    let html = `<div class="mb-4">`;
    
    // Mostra quantas notas fiscais tem - MESMA FONTE DA TABELA
    html += `<div class="text-sm text-gray-600 mb-2 font-sans">Notas Fiscais na Conferencia: ${notasFiscaisInfo.length}</div>`;
    
    // Mostra cada nota fiscal - MESMA FONTE DA TABELA
    notasFiscaisInfo.forEach((info, index) => {
        // âœ… MODIFICA APENAS NA EXIBIÃ‡ÃƒO DO FRONT-END
        let formattedInfo = info;
        
        // Substitui "NF:" por "Nfe:"
        formattedInfo = formattedInfo.replace(/NF:/g, 'Nfe:');
        
        // Substitui "Data:" por "Data de emissÃ£o:"
        formattedInfo = formattedInfo.replace(/Data:/g, 'Data de emissÃ£o:');
        
        // Substitui "Pedido:" por "Pedido Capta:"
        formattedInfo = formattedInfo.replace(/Pedido:/g, 'Pedido Capta:');
        
        html += `<div class="p-2 border-b border-gray-200 text-sm font-sans bg-blue-200">${formattedInfo}</div>`;
    });
    
    html += `</div>`;
    return html;
}
        /**
         * Carrega os dados da Nota Fiscal especificamente para o cache de busca
         */
        async function loadNotaFiscalDataForCache() {
            try {
                const data = await fetchSheetData("NOTA FISCAL");
                updateNotaFiscalCache(data);
            } catch (error) {
                console.error("Erro ao carregar dados da Nota Fiscal para cache:", error);
            }
        }

        /**
         * Atualiza o cache local com os dados da Nota Fiscal para busca rÃ¡pida
         */
        function updateNotaFiscalCache(data) {
            if (!data || data.length === 0) {
                notaFiscalData = [];
                codigoBarrasIndex = {};
                return;
            }

            notaFiscalData = data;
            codigoBarrasIndex = {};

            const dataRows = (data.length > 0 && data[0][0] === "DescriÃ§Ã£o") ? data.slice(1) : data;

            dataRows.forEach(row => {
                if (row.length >= 3) {
                    const descricao = row[0] || '';
                    const codigoBarras = String(row[2] || '').trim();
                    
                    if (codigoBarras && codigoBarras !== '') {
                        codigoBarrasIndex[codigoBarras] = descricao;
                    }
                }
            });

            console.log(`Ãndice de cÃ³digos de barras atualizado: ${Object.keys(codigoBarrasIndex).length} itens`);
        }

        /**
         * Busca a descriÃ§Ã£o correspondente a um cÃ³digo de barras no cache local
         */
        function buscarDescricaoPorCodigo(codigoBarras) {
            const codigoLimpo = String(codigoBarras).trim();
            return codigoBarrasIndex[codigoLimpo] || '';
        }

        /**
         * Manipula o input em tempo real nas cÃ©lulas da Contagem Loja
         */
        function handleContagemCellInput(element) {
            const codigoBarras = element.textContent.trim();
            lastInputTime = Date.now();
            
            if (codigoBarras && codigoBarras.length > 5) {
                const descricao = buscarDescricaoPorCodigo(codigoBarras);
                const row = element.closest('tr');
                const descCell = row.querySelector('.descricao-cell');
                
                if (descricao) {
                    if (descCell && descCell.textContent.trim() !== descricao) {
                        descCell.textContent = descricao;
                        row.classList.remove('bg-red-50');
                        
                        const cacheKey = `${CACHE_KEY}_${currentContador}`;
                        const cachedData = loadFromCache(cacheKey);
                        const sheetRangeC = descCell.getAttribute('data-sheet-range');
                        cachedData[sheetRangeC] = descricao;
                        saveToCache(cachedData, cacheKey);
                    }
                } else {
                    if (descCell) {
                        descCell.textContent = '';
                    }
                }
            }
        }

        /**
         * Alterna entre os contadores dentro da aba Contagem Loja
         */
        async function switchContador(contadorName) {
            const cacheKeyCurrent = `${CACHE_KEY}_${currentContador}`;
            const cachedDataCurrent = loadFromCache(cacheKeyCurrent);
            const hasData = Object.keys(cachedDataCurrent).filter(key => key.startsWith('A')).length > 0;
            
            if (hasData) {
                console.log(`ðŸ”„ Auto-save: Saindo do ${currentContador}, enviando dados...`);
                showNotification(`Salvando dados do ${currentContador}...`, 'loading', 2000);
                await processBatchUpdate();
            }
            
            currentContador = contadorName;
            
            const contadorButtons = document.querySelectorAll('.contador-button');
            contadorButtons.forEach(btn => {
                if (btn.getAttribute('data-contador') === contadorName) {
                    btn.classList.add('border-blue-600', 'text-blue-600');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                } else {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                }
            });

            const targetElement = document.getElementById('dynamic-table-content-contagem');
            if (targetElement) {
                targetElement.innerHTML = `<div class="text-center py-10 text-gray-500">Carregando dados do ${contadorName}...</div>`;
            }

            const data = await fetchSheetData(contadorName);
            const headers = ["CÃ³digo de Barras", "DescriÃ§Ã£o"];
            
            if (targetElement) {
                targetElement.innerHTML = renderContagemTableFixedRows(data, headers);
                
                updatePendingCount();
                
                startCacheChangeMonitor();
                
                setTimeout(() => {
                    requestAnimationFrame(focusNextEmptyContagemCell);
                }, 100);
            }
        }

   
        /**
         * CORRIGIDO: Encontra a primeira cÃ©lula vazia (apÃ³s a Ãºltima preenchida) na Contagem Loja, 
         * foca nela e rola a tela.
         */
        function focusNextEmptyContagemCell() {
            const cells = document.querySelectorAll('#contagem-table td[contenteditable="true"]');
            
            let cellToFocus = null; 
            let lastFilledCellIndex = -1;
            
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const value = cell.textContent.trim();
                
                if (value !== '') {
                    lastFilledCellIndex = i; 
                }
            }
            
            const targetCellIndex = lastFilledCellIndex + 1;
            
            if (targetCellIndex < cells.length) {
                cellToFocus = cells[targetCellIndex];
            } else if (cells.length > 0) {
                 cellToFocus = cells[cells.length - 1];
                 showNotification("Aviso: A lista de contagem pode estar cheia (3000 linhas). Foco na Ãºltima cÃ©lula preenchida.", 'warning', 5000);
            }
            
            if (cellToFocus) {
                cellToFocus.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                cellToFocus.focus();
                
                moveCursorToEnd(cellToFocus); 
            }
        }


        /**
         * UtilitÃ¡rio para mover o cursor de ediÃ§Ã£o para o final do texto em uma cÃ©lula contenteditable.
         */
        function moveCursorToEnd(element) {
            const range = document.createRange();
            const selection = window.getSelection();
            
            if (element.childNodes.length > 0) {
                 const node = element.childNodes[0];
                 if (node.nodeType === 3) {
                     range.setStart(node, node.length);
                 } else {
                     range.setStart(element, 0);
                 }
            } else {
                 range.setStart(element, 0);
            }

            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // --- SISTEMA DE CACHE E ATUALIZAÃ‡ÃƒO EM LOTE ---

        /**
         * Carrega dados do cache local - AGORA COM SUPORTE A MÃšLTIPLOS CONTADORES
         */
        function loadFromCache(cacheKey = CACHE_KEY) {
            try {
                const cached = localStorage.getItem(cacheKey);
                if (!cached) return {};
                
                const cacheData = JSON.parse(cached);
                
                if (Date.now() - cacheData.timestamp > CACHE_DURATION) {
                    localStorage.removeItem(cacheKey);
                    return {};
                }
                
                return cacheData.data || {};
            } catch (error) {
                console.error('Erro ao carregar cache:', error);
                return {};
            }
        }

        /**
         * Salva dados no cache local - AGORA COM SUPORTE A MÃšLTIPLOS CONTADORES
         */
        function saveToCache(data, cacheKey = CACHE_KEY) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            } catch (error) {
                console.error('Erro ao salvar cache:', error);
            }
        }

        /**
         * Atualiza o contador de pendÃªncias na interface
         */
        function updatePendingCount() {
            const countElement = document.getElementById('pending-count');
            if (countElement) {
                const cacheKey = `${CACHE_KEY}_${currentContador}`;
                const cachedData = loadFromCache(cacheKey);
                
                const colunaACount = Object.keys(cachedData).filter(key => key.startsWith('A')).length;
                countElement.textContent = colunaACount;
                
                checkCacheChange();
            }
        }

        /**
         * Manipula a ediÃ§Ã£o de cÃ©lulas na Contagem Loja (com cache)
         */
        function handleContagemCellEdit(element, sheetRange, sheetName) {
            const newValue = element.textContent.trim();
            const originalValue = element.dataset.originalValue || '';

            if (newValue === originalValue) {
                return;
            }

            const cacheKey = `${CACHE_KEY}_${currentContador}`;
            const cachedData = loadFromCache(cacheKey);
            
            if (newValue === '') {
                delete cachedData[sheetRange];
                const rowIndex = sheetRange.slice(1);
                const sheetRangeC = `C${rowIndex}`;
                delete cachedData[sheetRangeC];
            } else {
                cachedData[sheetRange] = newValue;
                
                const descricao = buscarDescricaoPorCodigo(newValue);
                const row = element.closest('tr');
                const descCell = row.querySelector('.descricao-cell');
                
                if (descricao) {
                    if (descCell) {
                        descCell.textContent = descricao;
                        const sheetRangeC = descCell.getAttribute('data-sheet-range');
                        cachedData[sheetRangeC] = descricao;
                    }
                    row.classList.remove('bg-red-50');
                } else {
                    if (descCell) {
                        descCell.textContent = '';
                        const sheetRangeC = descCell.getAttribute('data-sheet-range');
                        delete cachedData[sheetRangeC];
                    }
                    row.classList.add('bg-red-50');
                    
                    const timeSinceInput = Date.now() - lastInputTime;
                    if (timeSinceInput > INPUT_DEBOUNCE) {
                        playErrorSoundIfAllowed();
                    }
                }
            }
            
            saveToCache(cachedData, cacheKey);

            element.dataset.originalValue = newValue;

            if (newValue !== '') {
                pendingUpdates.set(sheetRange, newValue);
                editCount++;
            } else {
                pendingUpdates.delete(sheetRange);
            }

            updatePendingCount();

            if (newValue !== '' && editCount >= BATCH_SIZE) {
                processBatchUpdate();
            }
        }

        /**
         * âš¡âš¡âš¡ FUNÃ‡ÃƒO CORRIGIDA: Processa atualizaÃ§Ã£o em lote - AGORA COM SUPORTE A MÃšLTIPLOS CONTADORES
         */
        async function processBatchUpdate() {
            const cacheKey = `${CACHE_KEY}_${currentContador}`;
            const cachedData = loadFromCache(cacheKey);
            
            if (Object.keys(cachedData).length === 0) {
                showNotification('Nenhum dado no cache para enviar', 'info', 2000);
                return;
            }

            showNotification(`Enviando ${Object.keys(cachedData).filter(key => key.startsWith('A')).length} cÃ©lulas do ${currentContador}...`, 'loading');

            try {
                const updates = Object.entries(cachedData).map(([range, value]) => ({
                    range: range,
                    value: value
                }));

                const response = await fetch(`${BACKEND_URL}/api/batch-update-sheet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        sheet_name: currentContador,
                        updates: updates 
                    })
                });

                const result = await response.json();
                hideNotification();

                if (response.ok && !result.error) {
                    localStorage.removeItem(cacheKey);
                    pendingUpdates.clear();
                    editCount = 0;
                    updatePendingCount();
                    
                    lastCacheCount = 0;
                    
                    showNotification(`${result.processed || updates.length} cÃ©lulas salvas no ${currentContador}!`, 'success', 3000);
                } else {
                    showNotification(`Erro: ${result.error}`, 'error');
                }
            } catch (error) {
                hideNotification();
                showNotification('Erro de rede', 'error');
            }
        }

        /**
         * âš¡âš¡âš¡ FUNÃ‡ÃƒO CORRIGIDA: ForÃ§a o envio do lote pendente
         */
        function forceBatchUpdate() {
            processBatchUpdate();
        }

        // --- SISTEMA DE SOM OTIMIZADO ---
        
        /**
         * Toca som APENAS se nÃ£o estiver no cooldown
         */
        function playErrorSoundIfAllowed() {
            const now = Date.now();
            const timeSinceLastSound = now - lastSoundTime;
            
            if (timeSinceLastSound < SOUND_COOLDOWN) {
                console.log(`â¸ï¸ Som ignorado: Cooldown ativo (${timeSinceLastSound}ms < ${SOUND_COOLDOWN}ms)`);
                return false;
            }
            
            soundCount++;
            console.log(`ðŸŽµ TOCANDO SOM ${soundCount}`);
            playErrorSound();
            lastSoundTime = now;
            return true;
        }

        /**
         * Toca som de BIP usando Web Audio API
         */
        function playErrorSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 500;
                oscillator.type = 'square';
                gainNode.gain.value = 0.3; 
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
            } catch (error) {
                console.log('Erro Web Audio:', error);
                try {
                    console.log('\x07');
                } catch (fallbackError) {
                    console.log('âŒ Nenhum mÃ©todo de Ã¡udio funcionou');
                }
            }
        }

        /**
         * GERENCIA O COMPORTAMENTO DO ENTER NA CONTAGEM LOJA.
         */
        function handleContagemKeyPress(event, sheetRange, sheetName) {
            if (event.keyCode === 13) {
                event.preventDefault();
                
                const element = event.target;
                const codigoBarras = element.textContent.trim();
                
                if (codigoBarras && codigoBarras.length > 5) {
                    const descricao = buscarDescricaoPorCodigo(codigoBarras);
                    const row = element.closest('tr');
                    const descCell = row.querySelector('.descricao-cell');
                    
                    if (descricao) {
                        if (descCell) {
                            descCell.textContent = descricao;
                        }
                        row.classList.remove('bg-red-50');
                    } else {
                        if (descCell) {
                            descCell.textContent = '';
                        }
                        row.classList.add('bg-red-50');
                        playErrorSoundIfAllowed();
                    }
                }
                
                handleContagemCellEdit(element, sheetRange, sheetName);

                const currentRow = parseInt(sheetRange.slice(1));
                const nextRow = currentRow + 1;
                const nextRange = `A${nextRow}`;
                const nextCell = document.querySelector(`td[data-sheet-range="${nextRange}"]`);
                
                if (nextCell) {
                    nextCell.focus();
                    moveCursorToEnd(nextCell); 
                    nextCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    showNotification("Fim da lista prÃ©-renderizada. Pressione F5 para recarregar a pÃ¡gina e continuar a contagem.", 'warning', 5000);
                }
            }
        }

        /**
         * Manipula o evento keydown nas cÃ©lulas da Contagem Loja
         */
        function handleContagemCellKeydown(event, element) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        }

        /**
        /**
 /**
 * ðŸ”„ ALTERNA ENTRE MODO SCROLL E MODO EXPANDIDO (ORIGINAL)
 */

		/*
function toggleScrollMode(sheetName) {
    const tableID = sheetName === 'CONFERENCIA' ? 'conferencia-table' : 'notafiscal-table';
    const buttonID = sheetName === 'CONFERENCIA' ? 'scroll-button-conferencia' : 'scroll-button-notafiscal';

    const table = document.getElementById(tableID);
    const button = document.getElementById(buttonID);

    if (!table || !button) return;
    
    const isScrollModeActive = button.textContent === 'Modo Expandido';
    
    let columnsToTarget = [];
    const scrollClassDesc = 'scroll-mode-cell';
    const scrollClassNumeric = 'scroll-mode-cell-numeric';
    const scrollClassCode = 'scroll-mode-cell-code'; 

    if (sheetName === 'CONFERENCIA') {
        columnsToTarget = [1, 2, 3, 4, 5, 6];
    } else if (sheetName === 'NOTA FISCAL') {
        columnsToTarget = [1, 2, 3, 4];
    }

    columnsToTarget.forEach(colIndex => {
        const cells = table.querySelectorAll(`th:nth-child(${colIndex}), td:nth-child(${colIndex})`);
        
        cells.forEach(cell => {
            
            if (isScrollModeActive) {
                cell.classList.remove(scrollClassDesc, scrollClassNumeric, scrollClassCode);
                cell.classList.add('expand-mode-cell'); 
            } else {
                cell.classList.remove('expand-mode-cell');

                if (sheetName === 'CONFERENCIA') {
                    if (colIndex === 1) {
                        cell.classList.add(scrollClassCode); 
                    } 
                    else if (colIndex === 2) {
                        cell.classList.add(scrollClassDesc);
                    }
                    else if (colIndex >= 3 && colIndex <= 6) {
                        cell.classList.add(scrollClassNumeric);
                    }
                    
                } else if (sheetName === 'NOTA FISCAL') {
                    if (colIndex === 2 || colIndex === 4) {
                        cell.classList.add(scrollClassNumeric);
                    } else if (colIndex === 3) {
                        cell.classList.add(scrollClassCode); 
                    } else { 
                        cell.classList.add(scrollClassDesc);
                    }
                }
            }
        });
    });

    if (isScrollModeActive) {
        button.textContent = 'Modo Scroll';
        button.classList.remove('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200', 'border-gray-300');
        button.classList.add('bg-indigo-100', 'text-indigo-700', 'hover:bg-indigo-200', 'border-indigo-300');
    } else {
        button.textContent = 'Modo Expandido';
        button.classList.remove('bg-indigo-100', 'text-indigo-700', 'hover:bg-indigo-200', 'border-indigo-300');
        button.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200', 'border-gray-300');
    }
}
*/

/**
 * ðŸ“œ APLICAR MODO SCROLL
 */
function applyScrollMode(table, sheetName, columnsToTarget) {
    const scrollClassDesc = 'scroll-mode-cell';
    const scrollClassNumeric = 'scroll-mode-cell-numeric';
    const scrollClassCode = 'scroll-mode-cell-code';

    columnsToTarget.forEach(colIndex => {
        const cells = table.querySelectorAll(`th:nth-child(${colIndex}), td:nth-child(${colIndex})`);
        
        cells.forEach(cell => {
            if (sheetName === 'CONFERENCIA') {
                if (colIndex === 1) {
                    cell.classList.add(scrollClassCode);
                } else if (colIndex === 2) {
                    cell.classList.add(scrollClassDesc);
                } else if (colIndex >= 3 && colIndex <= 6) {
                    cell.classList.add(scrollClassNumeric);
                }
            } else if (sheetName === 'NOTA FISCAL') {
                if (colIndex === 2 || colIndex === 4) {
                    cell.classList.add(scrollClassNumeric);
                } else if (colIndex === 3) {
                    cell.classList.add(scrollClassCode);
                } else {
                    cell.classList.add(scrollClassDesc);
                }
            }
        });
    });
}

/**
 * âœ‚ï¸ APLICAR MODO TRUNCATE (RETICÃŠNCIAS)
 */
function applyTruncateMode(table, sheetName, columnsToTarget) {
    columnsToTarget.forEach(colIndex => {
        const cells = table.querySelectorAll(`th:nth-child(${colIndex}), td:nth-child(${colIndex})`);
        cells.forEach(cell => {
            cell.classList.add('truncate-mode-cell');
        });
    });
}

/**
 * ðŸ“ APLICAR MODO EXPANDIDO
 */
function applyExpandMode(table, columnsToTarget) {
    columnsToTarget.forEach(colIndex => {
        const cells = table.querySelectorAll(`th:nth-child(${colIndex}), td:nth-child(${colIndex})`);
        cells.forEach(cell => {
            cell.classList.add('expand-mode-cell');
        });
    });
}
   /**
 * âœ… APLICA FORMATAÃ‡ÃƒO CONDICIONAL NA ABA CONFERENCIA - VERSÃƒO CORRIGIDA
 * - DiferenÃ§a negativa: Vermelho apenas na coluna DiferenÃ§a
 * - DiferenÃ§a positiva: Verde apenas na coluna DiferenÃ§a  
 * - NÃƒO INTERFERE na coluna Danos/Defeito
 */
function applyConferenciaStyles(numCols) {
    const rows = document.querySelectorAll('#conferencia-content .mock-table tbody tr');

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 7) return;

        const diferencaCell = cells[4]; // 5Âª coluna (DiferenÃ§a)
        
        // âœ… APENAS A COLUNA DIFERENÃ‡A Ã‰ ESTILIZADA
        if (diferencaCell) {
            diferencaCell.classList.remove('bg-fee2e2', 'text-b91c1c', 'bg-green-100', 'text-green-700');
            
            let value = parseFloat(diferencaCell.textContent.replace(',', '.').trim());
            
            if (!isNaN(value)) {
                if (value < 0) {
                    diferencaCell.classList.add('bg-fee2e2', 'text-b91c1c');
                } else if (value > 0) {
                    diferencaCell.classList.add('bg-green-100', 'text-green-700');
                }
            }
        }
        
        // âœ… COLUNA DANOS/DEFEITO NÃƒO Ã‰ AFETADA POR ESTA FUNÃ‡ÃƒO
        // (mantÃ©m seus prÃ³prios estilos independentemente)
    });
}
        // --- FunÃ§Ãµes de API e UtilitÃ¡rios ---
        
        async function fetchSheetData(sheetName) {
            showNotification(`Buscando dados da aba '${sheetName}'...`, 'loading');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/fetch-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sheet_name: sheetName })
                });

                const result = await response.json();

                if (!response.ok || result.error) {
                    hideNotification();
                    showNotification(`Erro ao carregar '${sheetName}': ${result.error || 'Erro de servidor.'}`, 'error');
                    return [];
                }
                
                hideNotification();
                return result.data || [];

            } catch (error) {
                hideNotification();
                console.error("Erro na comunicaÃ§Ã£o para buscar dados:", error);
                showNotification(`Erro de Rede/CORS ao buscar dados para ${sheetName}.`, 'error');
                return [];
            }
        }

        async function importXMLData(xmlContent) {
    if (!xmlContent || xmlContent.trim().length < 100) {
        showNotification("ConteÃºdo XML vazio ou invÃ¡lido para importaÃ§Ã£o.", 'warning');
        return;
    }

    showNotification("Enviando XML para o backend...", 'loading');

    try {
        const response = await fetch(`${BACKEND_URL}/api/import-xml-data`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ xml_content: xmlContent, user_id: USER_ID })
        });

        const result = await response.json();
        hideNotification();

        if (!response.ok || result.error) {
            showNotification(`Falha na ImportaÃ§Ã£o: ${result.error || 'Erro desconhecido do servidor.'}`, 'error');
        } else {
            // âœ… LIMPAR CACHE DOS AJUSTES AO IMPORTAR NOVA NOTA
            localStorage.removeItem(CONFERENCE_ADJUSTMENTS_KEY);
            showNotification(result.message, 'success');
            switchTab("NOTA FISCAL");
        }

    } catch (error) {
        hideNotification();
        console.error("Erro de Rede:", error);
        showNotification("Erro de Rede ao tentar conectar com o servidor.", 'error');
    }
}

        /**
         * âœ… FUNÃ‡ÃƒO CORRIGIDA: Importa XML por chave ignorando espaÃ§os E EXIBE INFORMAÃ‡Ã•ES
         */
        async function importarXMLPorChave() {
    const chaveInput = document.getElementById("chave-acesso-input");
    if (!chaveInput) {
        showNotification("Campo de chave nÃ£o encontrado.", "error");
        return;
    }
    
    let chaveAcesso = chaveInput.value.replace(/\s+/g, '');
    
    if (!chaveAcesso || chaveAcesso.length !== 44) {
        showNotification(`Chave de acesso invÃ¡lida. Deve conter 44 dÃ­gitos. (Atual: ${chaveAcesso.length} dÃ­gitos)`, "warning");
        return;
    }

    // âœ… VERIFICAÃ‡ÃƒO DE DUPLICIDADE - Busca na planilha atual
    const currentData = await fetchSheetData("NOTA FISCAL");
    const chaveExists = checkIfChaveExists(currentData, chaveAcesso);
    
    if (chaveExists) {
        showNotification("Esta nota fiscal jÃ¡ foi importada anteriormente!", "error");
        return;
    }

    showNotification("Importando XML pela chave de acesso...", "loading");

    try {
        const response = await fetch(`${BACKEND_URL}/api/importar-xml-chave`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: 'include',
            body: JSON.stringify({ chaveAcesso })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        
        if (result.error) {
            hideNotification();
            showNotification(`Erro: ${result.error}`, "error");
            return;
        }

        hideNotification();
        // âœ… LIMPAR CACHE DOS AJUSTES AO IMPORTAR NOVA NOTA
        localStorage.removeItem(CONFERENCE_ADJUSTMENTS_KEY);
        showNotification(result.message, "success", 5000);

        chaveInput.value = '';
        hidePasteModal();
        
        setTimeout(() => {
            switchTab("NOTA FISCAL");
        }, 1000);

    } catch (error) {
        hideNotification();
        console.error("Erro ao importar XML por chave:", error);
        
        if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
            showNotification("Erro de conexÃ£o com o servidor. Verifique sua internet.", "error");
        } else {
            showNotification(`Erro: ${error.message}`, "error");
        }
    }
}

        /**
         * âœ… FUNÃ‡ÃƒO AUXILIAR: Verifica se a chave jÃ¡ existe nos dados atuais
         */
        function checkIfChaveExists(data, chaveAcesso) {
            if (!data || !Array.isArray(data)) return false;
            
            // Converte a chave para o formato que aparece na planilha ("Chave: XXXXXXXXXXXXXXXXX")
            const chaveFormatada = `Chave: ${chaveAcesso}`;
            
            // Procura em todas as linhas
            for (let row of data) {
                if (row && Array.isArray(row)) {
                    for (let cell of row) {
                        if (cell && String(cell).includes(chaveFormatada)) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        /**
         * FunÃ§Ã£o CRUCIAL: Envia o novo valor da cÃ©lula editÃ¡vel para o Google Sheets.
         */
        async function handleCellEdit(element, sheetRange, sheetName) {
            const newValue = element.textContent.trim();
            const originalValue = element.dataset.originalValue; 

            if (newValue === originalValue) {
                return;
            }

            element.classList.add('saving-status'); 

            try {
                const response = await fetch(`${BACKEND_URL}/api/update-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sheet_name: sheetName, range: sheetRange, value: newValue })
                });

                const result = await response.json();

                element.classList.remove('saving-status');

                if (!response.ok || result.error) {
                    showNotification(`Erro ao salvar ${sheetRange}: ${result.error || 'Erro de servidor.'}`, 'error');
                    element.textContent = originalValue; 
                } else {
                    element.dataset.originalValue = newValue;
                    showNotification(`CÃ©lula ${sheetRange} atualizada com sucesso para '${newValue}'.`, 'success', 2000);
                }

            } catch (error) {
                element.classList.remove('saving-status');
                console.error("Erro na comunicaÃ§Ã£o para atualizar cÃ©lula:", error);
                showNotification(`Erro de Rede ao tentar atualizar ${sheetRange}.`, 'error');
                element.textContent = originalValue;
            }
        }

        
        /**
         * CONFIGURAÃ‡ÃƒO ATUALIZADA: Inclui todos os contadores para limpeza
         */
        const sheetsConfig = [
            { name: "NOTA FISCAL", range: 'A2:Z' },
            { name: "CONTAGEM LOJA", range: 'A1:C3000' },
            { name: "CONTADOR 2", range: 'A1:C3000' },
            { name: "CONTADOR 3", range: 'A1:C3000' },
            { name: "CONTADOR 4", range: 'A1:C3000' },
            { name: "CONTADOR 5", range: 'A1:C3000' },
            { name: "CONFERENCIA", range: 'G2:G' } 
        ];

        function confirmClearAllSheets() {
            const confirmationMessage = "ATENÃ‡ÃƒO: VocÃª tem certeza que deseja APAGAR TODOS os dados?\n\nIsso irÃ¡:\n- Limpar Nota Fiscal\n- Limpar TODOS os dados das colunas A e C de TODOS os contadores (1-5)\n- Limpar OBS da ConferÃªncia\n- Limpar caches locais\n\nEsta aÃ§Ã£o Ã© IRREVERSÃVEL!";
            
            if (confirm(confirmationMessage)) {
                clearMultipleSheets();
            }
        }

        async function clearMultipleSheets() {
    showNotification(`Iniciando limpeza completa...`, 'loading', 30000);

    let successCount = 0;
    let errorCount = 0;

    for (const config of sheetsConfig) {
        const result = await clearSheetData(config.name, config.range, false); 
        if (result.success) {
            successCount++;
        } else {
            errorCount++;
            showNotification(`Erro ao limpar a aba '${config.name}' (Range: ${config.range}).`, 'error', 4000);
        }
    }

    const contadores = ['CONTAGEM LOJA', 'CONTADOR 2', 'CONTADOR 3', 'CONTADOR 4', 'CONTADOR 5'];
    contadores.forEach(contador => {
        const cacheKey = `${CACHE_KEY}_${contador}`;
        localStorage.removeItem(cacheKey);
    });

    // âœ… ADICIONE ESTA LINHA PARA LIMPAR CACHE DOS AJUSTES
    localStorage.removeItem(CONFERENCE_ADJUSTMENTS_KEY);

    pendingUpdates.clear();
    editCount = 0;
    updatePendingCount();

    lastCacheCount = 0;

    hideNotification();

    if (errorCount === 0) {
        showNotification(`Limpeza completa concluÃ­da! ${successCount} aÃ§Ãµes realizadas. Caches locais limpos.`, 'success', 5000);
    } else {
         showNotification(`Limpeza concluÃ­da com ${errorCount} erro(s). Caches locais foram limpos.`, 'warning', 8000);
    }

    const activeTab = document.querySelector('.tab-button.border-indigo-600').dataset.tab;
    if (activeTab === "CONTAGEM LOJA") {
        switchContador(currentContador);
    } else {
        switchTab(activeTab);
    }
}

        async function clearSheetData(sheetName, range, showNotificationOnSuccess = true) {
            if (showNotificationOnSuccess) {
                showNotification(`Limpando dados da aba '${sheetName}' (Range: ${range})...`, 'loading');
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/clear-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sheet_name: sheetName, range: range })
                });

                const result = await response.json();
                
                if (showNotificationOnSuccess) {
                    hideNotification();
                }

                if (!response.ok || result.error) {
                    if (showNotificationOnSuccess) {
                        showNotification(`Erro ao limpar '${sheetName}': ${result.error || 'Erro de servidor.'}`, 'error');
                    }
                    return { success: false, error: result.error || 'Erro de servidor.' };
                } else {
                    if (showNotificationOnSuccess) {
                        showNotification(result.message, 'success');
                    }
                    return { success: true, message: result.message };
                }

            } catch (error) {
                if (showNotificationOnSuccess) {
                    hideNotification();
                    showNotification(`Erro de Rede/CORS ao limpar dados.`, 'error');
                }
                console.error(`Erro de rede ao tentar limpar ${sheetName}:`, error);
                return { success: false, error: 'Erro de rede/comunicaÃ§Ã£o.' };
            }
        }


        /**
         * Extrai informaÃ§Ãµes especÃ­ficas do XML
         */
        function extrairInformacoesXML(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                // Extrai Pedido Capta
                const xPedElement = xmlDoc.getElementsByTagName('xPed')[0];
                const pedidoCapta = xPedElement ? xPedElement.textContent : 'NÃ£o encontrado';
                
                // Extrai NÃºmero da Nota Fiscal
                const nNFElement = xmlDoc.getElementsByTagName('nNF')[0];
                const numeroNota = nNFElement ? nNFElement.textContent : 'NÃ£o encontrado';
                
                // Extrai Data de EmissÃ£o (apenas a parte da data)
                const dhEmiElement = xmlDoc.getElementsByTagName('dhEmi')[0];
                let dataEmissao = 'NÃ£o encontrada';
                if (dhEmiElement) {
                    const dataCompleta = dhEmiElement.textContent;
                    // Extrai apenas a parte da data (YYYY-MM-DD)
                    dataEmissao = dataCompleta.split('T')[0];
                }
                
                // Extrai Chave de Acesso (opcional - para confirmar)
                const chaveElement = xmlDoc.getElementsByTagName('chNFe')[0];
                const chaveAcesso = chaveElement ? chaveElement.textContent : 'NÃ£o encontrada';
                
                return {
                    pedidoCapta,
                    numeroNota,
                    dataEmissao,
                    chaveAcesso
                };
            } catch (error) {
                console.error('Erro ao extrair informaÃ§Ãµes do XML:', error);
                return {
                    pedidoCapta: 'Erro na extraÃ§Ã£o',
                    numeroNota: 'Erro na extraÃ§Ã£o',
                    dataEmissao: 'Erro na extraÃ§Ã£o',
                    chaveAcesso: 'Erro na extraÃ§Ã£o'
                };
            }
        }

        // --- FunÃ§Ãµes de Modal e NotificaÃ§Ã£o (Tailwind) ---

        function showPasteModal() {
            document.getElementById('paste-modal').classList.remove('hidden');
            const chaveInput = document.getElementById("chave-acesso-input");
            if (chaveInput) {
                chaveInput.focus();
            }
        }

        function hidePasteModal() {
            document.getElementById('paste-modal').classList.add('hidden');
        }

        function showNotification(message, type = 'success', duration = 5000) {
            const container = document.getElementById('notifications-container');
            if (!container) {
                console.warn('Container de notificaÃ§Ãµes nÃ£o encontrado:', message);
                return;
            }
            
            hideNotification();
            
            let bgColor = 'bg-green-500';
            let icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;

            if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else if (type === 'loading' || type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${type === 'loading' ? 'animate-spin' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707" /></svg>`;
            }

            const notification = document.createElement('div');
            notification.className = `p-4 text-white ${bgColor} rounded-lg shadow-xl flex items-center space-x-3 transition-opacity duration-300 opacity-0`;
            notification.innerHTML = `
                <div>${icon}</div>
                <p class="font-medium">${message}</p>
            `;

            if (type === 'loading') {
                notification.id = 'loading-notification';
            } else {
                notification.id = 'temp-notification-' + Date.now();
            }

            container.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('opacity-0'), 10); 

            if (type !== 'loading') {
                setTimeout(() => {
                    notification.classList.add('opacity-0');
                    setTimeout(() => {
                        if (notification.parentNode === container) {
                            container.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
        }

        function hideNotification() {
            const container = document.getElementById('notifications-container');
            if (!container) return;
            
            const notifications = container.querySelectorAll('div');
            notifications.forEach(notification => {
                notification.classList.add('opacity-0');
                setTimeout(() => {
                    if (notification.parentNode === container) {
                        container.removeChild(notification);
                    }
                }, 300);
            });
        }
    
        /**
         * Alterna entre mostrar e ocultar a senha
         */
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eye-icon');
            const eyeSlashIcon = document.getElementById('eye-slash-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeSlashIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeSlashIcon.classList.add('hidden');
            }
        }

       function handleFileUploadChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const xmlContent = e.target.result;
                
                // âœ… EXTRAI A CHAVE DO XML PARA VERIFICAÃ‡ÃƒO DE DUPLICIDADE
                const chaveAcesso = extractChaveFromXML(xmlContent);
                if (chaveAcesso) {
                    const currentData = await fetchSheetData("NOTA FISCAL");
                    const chaveExists = checkIfChaveExists(currentData, chaveAcesso);
                    
                    if (chaveExists) {
                        showNotification("Esta nota fiscal jÃ¡ foi importada anteriormente!", "error");
                        event.target.value = null;
                        return;
                    }
                }

                showNotification("Enviando XML para importaÃ§Ã£o...", "loading");
                
                try {
                    const response = await fetch(`${BACKEND_URL}/api/import-xml-data`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ xml_content: xmlContent, user_id: USER_ID })
                    });

                    const result = await response.json();
                    hideNotification();

                    if (!response.ok || result.error) {
                        showNotification(`Falha na ImportaÃ§Ã£o: ${result.error || 'Erro desconhecido do servidor.'}`, 'error');
                    } else {
                        showNotification(result.message, 'success', 5000);
                        switchTab("NOTA FISCAL");
                    }

                } catch (error) {
                    hideNotification();
                    console.error("Erro de Rede:", error);
                    showNotification("Erro de Rede ao tentar conectar com o servidor.", 'error');
                }
            };
            reader.onerror = function() {
                showNotification("Erro ao ler o arquivo XML.", 'error');
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        /**
         * âœ… FUNÃ‡ÃƒO AUXILIAR: Extrai chave de acesso do XML
         */
        function extractChaveFromXML(xmlContent) {
            try {
                const match = xmlContent.match(/<infNFe[^>]*Id="NFe([^"]+)"/);
                return match ? match[1] : null;
            } catch (error) {
                console.error("Erro ao extrair chave do XML:", error);
                return null;
            }
        }

        // âœ… DETECTA SE ESTÃ NO APK ANDROID E CONFIGURA IMPRESSÃƒO
        function setupAndroidPrint() {
            // Verifica se estÃ¡ no APK Android (interface Android existe)
            const isAndroidApp = typeof Android !== 'undefined';
            
            if (isAndroidApp) {
                console.log("ðŸ“± APK Android detectado - Configurando impressÃ£o...");
                
                // Substitui a funÃ§Ã£o de impressÃ£o padrÃ£o
                const originalPrint = window.print;
                
                window.print = function() {
                    if (isAndroidApp) {
                        // Usa a funÃ§Ã£o nativa do Android
                        Android.printConferencia();
                        return true;
                    } else {
                        // Fallback para impressÃ£o normal do navegador
                        return originalPrint();
                    }
                };
                
                // TambÃ©m intercepta cliques no botÃ£o "Imprimir ConferÃªncia"
                document.addEventListener('click', function(e) {
                    const target = e.target;
                    if (target.textContent.includes('Imprimir ConferÃªncia') || 
                        target.textContent.includes('imprimir conferÃªncia') ||
                        target.onclick && target.onclick.toString().includes('printConferencia')) {
                        
                        if (isAndroidApp) {
                            e.preventDefault();
                            Android.printConferencia();
                        }
                    }
                });
                
                console.log("âœ… ImpressÃ£o Android configurada com sucesso!");
            }
        }

        // --- FUNÃ‡Ã•ES PARA CACHE DE AJUSTES DA CONFERÃŠNCIA ---

        /**
         * âœ… CARREGAR AJUSTES DO CACHE LOCAL
         */
        function loadConferenceAdjustments() {
            try {
                const cached = localStorage.getItem(CONFERENCE_ADJUSTMENTS_KEY);
                if (!cached) return {};
                
                const cacheData = JSON.parse(cached);
                
                // Cache vÃ¡lido por 24 horas
                if (Date.now() - cacheData.timestamp > (24 * 60 * 60 * 1000)) {
                    localStorage.removeItem(CONFERENCE_ADJUSTMENTS_KEY);
                    return {};
                }
                
                return cacheData.data || {};
            } catch (error) {
                console.error('Erro ao carregar cache de ajustes:', error);
                return {};
            }
        }

        /**
         * âœ… SALVAR AJUSTES NO CACHE LOCAL
         */
        function saveConferenceAdjustments(data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CONFERENCE_ADJUSTMENTS_KEY, JSON.stringify(cacheData));
                conferenceAdjustments = data; // Atualiza a variÃ¡vel global
            } catch (error) {
                console.error('Erro ao salvar cache de ajustes:', error);
            }
        }

        // âœ… FUNÃ‡ÃƒO IGUALAR CONTAGEM CORRIGIDA
async function igualarContagem(rowIndex, quantidadeNF) {
    try {
        showNotification(`Ajustando contagem localmente...`, 'loading');
        
        // âœ… SALVA NO CACHE LOCAL (nÃ£o envia para o Sheets)
        const adjustments = loadConferenceAdjustments();
        
        // Salva os ajustes para esta linha
        adjustments[`D${rowIndex}`] = quantidadeNF.toString();
        adjustments[`E${rowIndex}`] = "0";
        
        saveConferenceAdjustments(adjustments);
        
        // âœ… ATUALIZA APENAS A VISUALIZAÃ‡ÃƒO NO FRONTEND
        updateFrontendDisplay(rowIndex, quantidadeNF, 0);
        
        hideNotification();
        showNotification('Contagem ajustada localmente!', 'success', 3000);
        
        // âœ… NÃƒO CHAMA aplicarConferenciaStyles() AQUI - isso causa o problema
        // Em vez disso, atualiza apenas as cÃ©lulas especÃ­ficas
        setTimeout(() => {
            updateSingleRowStyles(rowIndex);
        }, 100);
        
    } catch (error) {
        hideNotification();
        console.error('Erro ao ajustar contagem:', error);
        showNotification('Erro ao ajustar contagem: ' + error.message, 'error');
    }
}

// âœ… FUNÃ‡ÃƒO PARA ATUALIZAR ESTILOS APENAS DA LINHA ESPECÃFICA
function updateSingleRowStyles(rowIndex) {
    const table = document.getElementById('conferencia-table');
    if (!table) return;
    
    const row = table.querySelector(`tr[data-row-index="${rowIndex}"]`);
    if (!row) return;
    
    const cells = row.querySelectorAll('td');
    if (cells.length >= 7) {
        const diferencaCell = cells[4]; // 5Âª coluna (DiferenÃ§a)
        const danosDefeitoCell = cells[6]; // 7Âª coluna (Danos/Defeito)
        
        // âœ… LIMPAR ESTILOS ANTERIORES
        diferencaCell.classList.remove('bg-fee2e2', 'text-b91c1c', 'bg-green-100', 'text-green-700');
        danosDefeitoCell.classList.remove('bg-red-100', 'bg-fee2e2', 'text-b91c1c');
        
        // âœ… APLICAR ESTILOS CORRETOS APENAS PARA DIFERENÃ‡A
        if (diferencaCell) {
            const diferencaText = diferencaCell.textContent.trim();
            const diferencaValue = parseFloat(diferencaText.replace(',', '.'));
            
            if (!isNaN(diferencaValue)) {
                if (diferencaValue < 0) {
                    diferencaCell.classList.add('bg-fee2e2', 'text-b91c1c');
                } else if (diferencaValue > 0) {
                    diferencaCell.classList.add('bg-green-100', 'text-green-700');
                }
            }
        }
        
        // âœ… NÃƒO APLICAR VERMELHO NA COLUNA DANOS automaticamente
        // Deixa a funÃ§Ã£o aplicarConferenciaStyles() cuidar disso depois
    }
}

        /**
         * âœ… ATUALIZA A VISUALIZAÃ‡ÃƒO NO FRONTEND
         */
        function updateFrontendDisplay(rowIndex, contagemLoja, diferenca) {
            const table = document.getElementById('conferencia-table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                if (row.getAttribute('data-row-index') === rowIndex.toString()) {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        // Atualiza coluna "Contagem Loja" (Ã­ndice 3)
                        if (cells[3]) {
                            cells[3].textContent = contagemLoja;
                        }
                        
                        // Atualiza coluna "DiferenÃ§a" (Ã­ndice 4)
                        if (cells[4]) {
                            cells[4].textContent = diferenca;
                            // Reaplica os estilos
                            applyConferenciaStyles(7);
                        }
                    }
                }
            });
        }

/**
 * âœ… EXPORTAR EXCEL CORRIGIDO - Inclui informaÃ§Ãµes das notas e exporta apenas o visÃ­vel
 */
function exportarParaExcel() {
    const isAndroidApp = typeof Android !== 'undefined';
    
    if (isAndroidApp) {
        Android.exportarParaExcel();
    } else {
        exportarCSVNoNavegador();
    }
}

/**
 * âœ… EXPORTAR CSV CORRIGIDO - Inclui informaÃ§Ãµes das notas e apenas linhas visÃ­veis
 */
function exportarCSVNoNavegador() {
    try {
        const tabela = document.getElementById('conferencia-table');
        if (!tabela) {
            showNotification('Tabela de conferÃªncia nÃ£o encontrada', 'error');
            return;
        }
        
        let csv = [];
        const BOM = "\uFEFF";
        const adjustments = loadConferenceAdjustments();
        
        // âœ… 1. INCLUIR INFORMAÃ‡Ã•ES DAS NOTAS FISCAIS
        const notasInfoElements = document.querySelectorAll('#dynamic-table-content-conferencia .mb-4 > div');
        if (notasInfoElements.length > 0) {
            // Adiciona tÃ­tulo para as informaÃ§Ãµes das notas
            csv.push('"INFORMAÃ‡Ã•ES DAS NOTAS FISCAIS"');
            
            notasInfoElements.forEach(notaElement => {
                let textoNota = notaElement.textContent.trim();
                textoNota = textoNota.replace(/"/g, '""');
                csv.push(`"${textoNota}"`);
            });
            
            // Linha em branco para separar
            csv.push('""');
        }
        
        // âœ… 2. CABEÃ‡ALHOS DA TABELA
        const cabecalhos = Array.from(tabela.querySelectorAll('thead th'))
            .map(th => {
                let texto = th.textContent.trim();
                texto = texto.replace(/"/g, '""');
                return `"${texto}"`;
            });
        csv.push(cabecalhos.join(';'));
        
        // âœ… 3. DADOS DA TABELA - APENAS LINHAS VISÃVEIS E COM AJUSTES APLICADOS
        const linhas = tabela.querySelectorAll('tbody tr');
        let linhasExportadas = 0;
        
        linhas.forEach(linha => {
            // âœ… VERIFICA SE A LINHA ESTÃ VISÃVEL (nÃ£o oculta pelo filtro)
            const estilo = window.getComputedStyle(linha);
            if (estilo.display === 'none') {
                return; // Pula linhas ocultas
            }
            
            const rowIndex = linha.getAttribute('data-row-index');
            const celulas = Array.from(linha.querySelectorAll('td'));
            
            const celulasExport = celulas.map((td, index) => {
                let texto = td.textContent.trim();
                
                // âœ… APLICA AJUSTES DO CACHE PARA EXPORTAÃ‡ÃƒO
                if (rowIndex && adjustments) {
                    if (index === 3 && adjustments[`D${rowIndex}`] !== undefined) {
                        texto = adjustments[`D${rowIndex}`];
                    } else if (index === 4 && adjustments[`E${rowIndex}`] !== undefined) {
                        texto = adjustments[`E${rowIndex}`];
                    }
                }
                
                // FormataÃ§Ã£o para Excel
                if (index === 0 && texto) {
                    texto = "\t" + texto;
                }
                
                texto = texto.replace(/"/g, '""');
                texto = texto.replace(/\n/g, ' ');
                texto = texto.replace(/\r/g, ' ');
                return `"${texto}"`;
            });
            
            if (celulasExport.length > 0 && celulasExport.some(cell => cell !== '""')) {
                csv.push(celulasExport.join(';'));
                linhasExportadas++;
            }
        });
        
        // âœ… 4. CRIA CSV COM BOM E ENCODING CORRETO
        const csvContent = BOM + csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // âœ… 5. NOME DO ARQUIVO INCLUI DATA E STATUS DO FILTRO
        const dataAtual = new Date().toISOString().split('T')[0];
        const horaAtual = new Date().toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        }).replace(/:/g, '-');
        
        const filtroAtivo = document.getElementById('divergencias-button').textContent.includes('Mostrar todas');
        const statusFiltro = filtroAtivo ? 'filtrado' : 'completo';
        
        a.download = `conferencia_nfe_${dataAtual}_${horaAtual}_${statusFiltro}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // âœ… 6. FEEDBACK DETALHADO
        const totalLinhas = linhas.length;
        const mensagem = `Arquivo Excel exportado com sucesso! 
                         ${linhasExportadas} de ${totalLinhas} linhas ${filtroAtivo ? '(filtradas)' : '(todas)'}
                         ${notasInfoElements.length > 0 ? '+ informaÃ§Ãµes das notas fiscais' : ''}`;
        
        showNotification(mensagem, 'success', 5000);
        
    } catch (error) {
        console.error('Erro ao exportar:', error);
        showNotification('Erro ao exportar: ' + error.message, 'error');
    }
}
        // âœ… FUNÃ‡ÃƒO COMPARTILHAR EM PDF (MELHORADA)
        function compartilharEmPDF() {
            const isAndroidApp = typeof Android !== 'undefined';
            
            if (isAndroidApp) {
                Android.compartilharEmPDF();
            } else {
                // No navegador - instruÃ§Ãµes claras
                showNotification('Para salvar como PDF: 1. Clique em Imprimir â†’ 2. Escolha "Salvar como PDF" â†’ 3. Selecione local', 'info', 5000);
                window.print();
            }
        }

        // --- InicializaÃ§Ã£o ---

        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸŽ¯ DOM Carregado - Iniciando app...");
            
            // Configura listeners de teclado
            const chaveInput = document.getElementById("chave-acesso-input");
            if (chaveInput) {
                chaveInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        importarXMLPorChave(); 
                    }
                });
            }

            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // Configura impressÃ£o Android
            setTimeout(setupAndroidPrint, 1000);
            
            // Inicializa com delay para WebView
            setTimeout(() => {
                initializeApp();
            }, 1000);
        });

        // âœ… TAMBÃ‰M EXECUTA QUANDO A PÃGINA ESTIVER COMPLETAMENTE CARREGADA
        window.addEventListener('load', function() {
            setTimeout(setupAndroidPrint, 500);
        });
// =========================================================================
// SISTEMA DE BUSCA UNIVERSAL
// =========================================================================

let currentSearchTerm = '';

/**
 * ðŸ‘ï¸ MOSTRAR/OCULTAR BOTÃƒO X BASEADO NO CONTEÃšDO
 */
function toggleClearButton() {
    const searchInput = document.getElementById('global-search-input');
    const clearButton = document.getElementById('clear-search-button');
    
    if (searchInput && clearButton) {
        if (searchInput.value.trim() !== '') {
            clearButton.classList.remove('hidden');
        } else {
            clearButton.classList.add('hidden');
        }
    }
}

/**
 * ðŸ—‘ï¸ LIMPAR BUSCA
 */
function clearSearch() {
    document.getElementById('global-search-input').value = '';
    currentSearchTerm = '';
    
    // Ocultar botÃ£o X
    toggleClearButton();
    
    // Restaurar todas as linhas
    const tables = document.querySelectorAll('.mock-table');
    tables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.style.display = '';
            row.classList.remove('bg-yellow-50');
            
            // Remover highlights
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                cell.innerHTML = cell.textContent; // Remove marcaÃ§Ãµes HTML
            });
        });
    });
    
    showNotification('Busca limpa', 'info', 2000);
}

/**
 * ðŸ” BUSCA EM TODAS AS TABELAS COM CONTAGEM
 */
function performGlobalSearch() {
    const searchTerm = document.getElementById('global-search-input').value.trim().toLowerCase();
    currentSearchTerm = searchTerm;
    
    // Mostrar/ocultar botÃ£o X
    toggleClearButton();
    
    if (!searchTerm) {
        clearSearch();
        return;
    }

    // Busca em todas as tabelas visÃ­veis
    const tables = document.querySelectorAll('.mock-table');
    let totalResults = 0;
    let foundInAnyTable = false;

    tables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        let foundInThisTable = false;

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let rowContainsSearch = false;

            cells.forEach(cell => {
                const cellText = cell.textContent.toLowerCase();
                if (cellText.includes(searchTerm)) {
                    rowContainsSearch = true;
                    // Destacar o texto encontrado
                    highlightText(cell, searchTerm);
                }
            });

            if (rowContainsSearch) {
                row.style.display = '';
                row.classList.add('bg-yellow-50');
                foundInThisTable = true;
                foundInAnyTable = true;
                totalResults++; // âœ… CONTAR CADA LINHA ENCONTRADA
            } else {
                row.style.display = 'none';
                row.classList.remove('bg-yellow-50');
            }
        });

        // Mostrar mensagem se nÃ£o encontrou nesta tabela
        if (!foundInThisTable) {
            console.log(`NÃ£o encontrado na tabela: ${table.id}`);
        }
    });

    // Feedback visual COM CONTAGEM
    if (foundInAnyTable) {
        // âœ… MENSAGEM COM NÃšMERO DE RESULTADOS
        const resultText = totalResults === 1 ? '1 resultado encontrado' : `${totalResults} resultados encontrados`;
        showNotification(`Busca: "${searchTerm}" - ${resultText}`, 'success', 3000);
    } else {
        showNotification(`Busca: "${searchTerm}" - Nenhum resultado encontrado`, 'warning', 3000);
    }
}
/**
 * ðŸŽ¯ DESTACAR TEXTO ENCONTRADO
 */
function highlightText(element, searchTerm) {
    const text = element.textContent;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    const highlighted = text.replace(regex, '<mark class="bg-yellow-300 px-1 rounded">$1</mark>');
    element.innerHTML = highlighted;
}

/**
 * ðŸŽ¹ EVENT LISTENERS PARA BUSCA
 */
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('global-search-input');
    if (searchInput) {
        // Busca ao digitar
        searchInput.addEventListener('input', function(e) {
            const term = e.target.value.trim();
            toggleClearButton(); // Mostrar/ocultar X
            
            if (term.length >= 3) {
                performGlobalSearch();
            } else if (term.length === 0) {
                clearSearch();
            }
        });
        
        // Busca com Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performGlobalSearch();
            }
        });
        
        // Foco no campo - garantir que X aparece se tiver texto
        searchInput.addEventListener('focus', function() {
            if (this.value.trim() !== '') {
                toggleClearButton();
            }
        });
        
        // Perda de foco - manter X visÃ­vel se tiver texto
        searchInput.addEventListener('blur', function() {
            // Pequeno delay para permitir clique no X
            setTimeout(() => {
                if (this.value.trim() !== '') {
                    toggleClearButton();
                }
            }, 200);
        });
    }
    
    // Event listener para o botÃ£o X (prevenir conflitos)
    const clearButton = document.getElementById('clear-search-button');
    if (clearButton) {
        clearButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            clearSearch();
        });
        
        clearButton.addEventListener('mousedown', function(e) {
            e.preventDefault(); // Prevenir foco no input
        });
    }
});
		/**
 * âœ… FILTRAR APENAS DIVERGÃŠNCIAS
 * Mostra apenas linhas onde:
 * - Coluna "DiferenÃ§a" (5Âª coluna) â‰  0
 * - OU Coluna "OBS" (6Âª coluna) tem conteÃºdo
 */
function filtrarDivergencias() {
    const table = document.getElementById('conferencia-table');
    if (!table) {
        showNotification('Tabela de conferÃªncia nÃ£o encontrada', 'error');
        return;
    }

    const rows = table.querySelectorAll('tbody tr');
    const button = document.getElementById('divergencias-button');
    const isFilterActive = button.textContent.includes('Mostrar todas');
    
    let divergenciasCount = 0;
    let totalRows = 0;

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) {
            totalRows++;
            
            const diferencaCell = cells[4]; // 5Âª coluna (DiferenÃ§a)
            const danosDefeitoCell = cells[6]; // 7Âª coluna (Danos/Defeito e Obs)
            
            let isDivergencia = false;
            
            // Verifica se Ã© divergÃªncia (diferente de 0)
            if (diferencaCell) {
                const diferencaText = diferencaCell.textContent.trim();
                const diferencaValue = parseFloat(diferencaText.replace(',', '.'));
                if (!isNaN(diferencaValue) && diferencaValue !== 0) {
                    isDivergencia = true;
                }
            }
            
            // âœ… CORREÃ‡ÃƒO: VERIFICA APENAS O TEXTO REAL (nÃ£o o botÃ£o)
            if (danosDefeitoCell) {
                const elementoEditavel = danosDefeitoCell.querySelector('[contenteditable="true"]');
                const textoReal = elementoEditavel ? elementoEditavel.textContent.trim() : '';
                
                if (textoReal !== '') {
                    isDivergencia = true;
                }
            }
            
            if (isFilterActive) {
                // Modo "Mostrar todas" - mostra todas as linhas
                row.style.display = '';
                if (isDivergencia) {
                    row.classList.add('bg-yellow-50');
                    divergenciasCount++;
                } else {
                    row.classList.remove('bg-yellow-50');
                }
            } else {
                // Modo "Mostrar apenas divergÃªncias" - filtra
                if (isDivergencia) {
                    row.style.display = '';
                    row.classList.add('bg-yellow-50');
                    divergenciasCount++;
                } else {
                    row.style.display = 'none';
                    row.classList.remove('bg-yellow-50');
                }
            }
        }
    });
    
    // Alterna o texto do botÃ£o
    if (isFilterActive) {
        button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            <span>Mostrar apenas divergÃªncias</span>
        `;
        button.classList.remove('bg-green-100', 'text-green-700', 'border-green-300', 'hover:bg-green-200');
        button.classList.add('bg-red-100', 'text-red-700', 'border-red-300', 'hover:bg-red-200');
        showNotification(`Mostrando todas as ${totalRows} linhas`, 'info', 3000);
    } else {
        button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span>Mostrar todas as linhas</span>
        `;
        button.classList.remove('bg-red-100', 'text-red-700', 'border-red-300', 'hover:bg-red-200');
        button.classList.add('bg-green-100', 'text-green-700', 'border-green-300', 'hover:bg-green-200');
        showNotification(`Filtro aplicado: ${divergenciasCount} divergÃªncias de ${totalRows} linhas totais`, 'success', 4000);
    }
}

/**
 * âœ… ABRIR INTEGRAÃ‡ÃƒO DE NOTA
 * Abre o link do sistema Microvix em nova aba
 */
function abrirIntegracaoNota() {
    const url = 'https://linx.microvix.com.br/v4/home/index.asp';
    window.open(url, '_blank');
    showNotification('Abrindo sistema de integraÃ§Ã£o...', 'info', 2000);
}

		/**
 * âœ… CARREGAR AJUSTES DO CACHE LOCAL
 */
function loadConferenceAdjustments() {
    try {
        const cached = localStorage.getItem(CONFERENCE_ADJUSTMENTS_KEY);
        if (!cached) return {};
        
        const cacheData = JSON.parse(cached);
        
        // âœ… MUDAR PARA 1 HORA (ou menos) EM VEZ DE 24 HORAS
        if (Date.now() - cacheData.timestamp > (1 * 60 * 60 * 1000)) {
            localStorage.removeItem(CONFERENCE_ADJUSTMENTS_KEY);
            return {};
        }
        
        return cacheData.data || {};
    } catch (error) {
        console.error('Erro ao carregar cache de ajustes:', error);
        return {};
    }
}

		/**
 * âœ… MANIPULA EDIÃ‡ÃƒO NA COLUNA DANOS/DEFEITO E MANTÃ‰M FORMATAÃ‡ÃƒO
 */
function handleDanosDefeitoEdit(element, sheetRange, sheetName) {
    // Primeiro executa a ediÃ§Ã£o normal
    handleCellEdit(element, sheetRange, sheetName);
    
    // âœ… DEPOIS REAPLICA OS ESTILOS PARA ATUALIZAR AS CORES
    setTimeout(() => {
        aplicarConferenciaStyles(7);
    }, 100);
}


	/**
 * âœ… GERAR PDF DA CONFERÃŠNCIA PARA EMAIL
 */
function gerarPDFParaEmail() {
    // Verifica se estÃ¡ na aba CONFERENCIA
    const abaAtual = document.querySelector('.tab-button.border-indigo-600')?.dataset.tab;
    
    if (abaAtual !== 'CONFERENCIA') {
        // Se nÃ£o estiver na conferÃªncia, muda para ela primeiro
        switchTab('CONFERENCIA');
        showNotification('Carregando conferÃªncia para gerar PDF...', 'loading', 2000);
        
        // Espera carregar a conferÃªncia antes de gerar o PDF
        setTimeout(() => {
            window.print();
        }, 2500);
    } else {
        // JÃ¡ estÃ¡ na conferÃªncia, gera o PDF imediatamente
        window.print();
    }
}

/**
 * âœ… ABRIR OPÃ‡Ã•ES DE EMAIL
 */
function abrirOpcoesEmail() {
    // Primeiro gera o PDF DA CONFERÃŠNCIA
    gerarPDFParaEmail();
    
    // Mostra modal com opÃ§Ãµes
    const modalHtml = `
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6">
                <h3 class="text-lg font-bold mb-4">Enviar ConferÃªncia por Email</h3>
                <p class="text-sm text-gray-600 mb-4">
                    <strong>InstruÃ§Ãµes:</strong><br>
                    1. Salve o PDF da conferÃªncia<br>
                    2. Clique no seu provedor de email preferido<br>
                    3. Anexe o PDF manualmente no email
                </p>
                <div class="space-y-3">
                    <button onclick="abrirGmail()" class="w-full flex items-center space-x-3 px-4 py-3 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition duration-150 text-sm font-medium border border-red-200">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#EA4335" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#4285F4" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#34A853" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span>Abrir Gmail</span>
                    </button>
                    
                    <button onclick="abrirOutlook()" class="w-full flex items-center space-x-3 px-4 py-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition duration-150 text-sm font-medium border border-blue-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
    </svg>
    <span>Abrir Outlook</span>
</button>
                    
                    <button onclick="fecharModalEmail()" class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modal = document.createElement('div');
    modal.id = 'email-modal';
    modal.innerHTML = modalHtml;
    document.body.appendChild(modal);
}

/**
 * âœ… PREPARAR EMAIL COM PDF
 */
function prepararEmailComPDF(provedor = 'gmail') {
    showNotification('Gerando PDF da conferÃªncia...', 'loading', 2000);
    
    // Fecha o modal primeiro
    fecharModalEmail();
    
    // Pequeno delay para fechar o modal antes de abrir o PDF
    setTimeout(() => {
        // Gera o PDF
        window.print();
        
        // Abre o email apÃ³s um tempo (para dar tempo de salvar o PDF)
        setTimeout(() => {
            if (provedor === 'outlook') {
                abrirOutlook();
            } else {
                abrirGmail();
            }
        }, 2000);
        
    }, 500);
}

/**
 * âœ… FECHAR MODAL EMAIL
 */
function fecharModalEmail() {
    const modal = document.getElementById('email-modal');
    if (modal) {
        modal.remove();
    }
}

 

/**
 * âœ… EXTRAIR NOME DA LOJA DA URL
 */
function extrairNomeDaLoja() {
    const hostname = window.location.hostname;
    
    // Remove o .gtgo.com.br e pega a parte antes
    const partes = hostname.split('.');
    if (partes.length > 0) {
        let nomeLoja = partes[0];
        
        // Adiciona hÃ­fen entre letras e nÃºmeros
        nomeLoja = nomeLoja.replace(/([a-zA-Z])(\d)/, '$1-$2');
        
        // Remove tudo depois dos nÃºmeros
        nomeLoja = nomeLoja.replace(/(-\d+).*$/, '$1');
        
        return nomeLoja;
    }
    
    return 'Loja';
}

/**
 * âœ… EXTRAIR NÃšMEROS DAS NOTAS FISCAIS
 */
function extrairNumerosNotasFiscais() {
    const notas = [];
    
    // Procura pelas informaÃ§Ãµes das notas fiscais acima da tabela
    const elementosNotas = document.querySelectorAll('#dynamic-table-content-conferencia .mb-4 > div');
    
    elementosNotas.forEach(elemento => {
        const texto = elemento.textContent;
        
        // Procura por "Nfe:" seguido de nÃºmeros
        const matchNfe = texto.match(/Nfe:\s*(\d+)/i);
        if (matchNfe) {
            notas.push(matchNfe[1]);
        }
        
        // TambÃ©m procura por "NF:" (formato antigo)
        const matchNF = texto.match(/NF:\s*(\d+)/i);
        if (matchNF && !notas.includes(matchNF[1])) {
            notas.push(matchNF[1]);
        }
    });
    
    return notas;
}

/**
 * âœ… FORMATAR LISTA DE NOTAS FISCAIS
 */
function formatarNotasFiscais(notas) {
    if (notas.length === 0) return 'NFe(s) nÃ£o identificada(s)';
    if (notas.length === 1) return `Nfe: ${notas[0]}`;
    
    return `Nfe: ${notas.join(', ')}`;
}


	/**
 * âœ… ABRIR GMAIL
 */
function abrirGmail() {
    const nomeLoja = extrairNomeDaLoja();
    const notas = extrairNumerosNotasFiscais();
    const notasFormatadas = formatarNotasFiscais(notas);
    
    const assunto = `DivergÃªncia na NFe da (${nomeLoja}) - ${new Date().toLocaleDateString('pt-BR')}`;
    const corpo = `Prezado(a),\n\nSegue em anexo a divergÃªncia encontrada na nota fiscal ${notasFormatadas} da (${nomeLoja}).\n\nAtenciosamente\n`;
    
    const url = `https://mail.google.com/mail/?view=cm&fs=1&to=&su=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
    window.open(url, '_blank');
    fecharModalEmail();
}


/**
 * âœ… ABRIR OUTLOOK
 */
function abrirOutlook() {
    const nomeLoja = extrairNomeDaLoja();
    const notas = extrairNumerosNotasFiscais();
    const notasFormatadas = formatarNotasFiscais(notas);
    
    const assunto = `DivergÃªncia na NFe da (${nomeLoja}) - ${new Date().toLocaleDateString('pt-BR')}`;
    const corpo = `Prezado(a),%0D%0A%0D%0ASegue em anexo a divergÃªncia encontrada na nota fiscal ${notasFormatadas} da (${nomeLoja}).%0D%0A%0D%0AAtenciosamente,%0D%0A`;
    
    const url = `https://outlook.live.com/mail/0/deeplink/compose?to=&subject=${encodeURIComponent(assunto)}&body=${corpo}`;
    window.open(url, '_blank');
    fecharModalEmail();
}






// âœ… MANTENHA AS OUTRAS FUNÃ‡Ã•ES IGUAIS:
// - mostrarOpcoesDanos()
// - adicionarOpcaoDano()
// - fecharMenuDanos()
// (elas jÃ¡ estÃ£o boas, sÃ³ usam as novas funÃ§Ãµes acima)






// âœ… VARIÃVEL GLOBAL COM QUANTIDADE
let opcoesDanosDefeito = []; // Agora serÃ¡ array de objetos

// âœ… CONVERTER array antigo para novo formato (se necessÃ¡rio)
function converterParaNovoFormato(opcoesAntigas) {
    if (!opcoesAntigas || opcoesAntigas.length === 0) return [];
    
    // Se jÃ¡ Ã© array de objetos, retorna como estÃ¡
    if (typeof opcoesAntigas[0] === 'object') {
        return opcoesAntigas;
    }
    
    // Se Ã© array de strings, converte para objetos
    return opcoesAntigas.map(frase => ({
        texto: frase,
        quantidade: 1
    }));
}

// âœ… CARREGAR OPÃ‡Ã•ES (com conversÃ£o)
async function carregarOpcoesDanosDefeito() {
    try {
        console.log('ðŸ“¡ Carregando opÃ§Ãµes do Google Sheets...');
        const response = await fetch(`${BACKEND_URL}/api/opcoes-danos-defeito`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && Array.isArray(result.opcoes)) {
                // âœ… CONVERTE para novo formato se necessÃ¡rio
                const opcoesConvertidas = converterParaNovoFormato(result.opcoes);
                console.log('âœ… OpÃ§Ãµes carregadas:', opcoesConvertidas);
                return opcoesConvertidas;
            }
        }
        
        return [];
        
    } catch (error) {
        console.error('âŒ Erro ao carregar:', error);
        showNotification('Erro ao carregar frases', 'error', 3000);
        return [];
    }
}

// âœ… SALVAR OPÃ‡Ã•ES (CORRIGIDA - converte para formato backend)
async function salvarOpcoesDanosDefeito(opcoes) {
    if (!Array.isArray(opcoes)) {
        console.error('âŒ Tentativa de salvar opÃ§Ãµes invÃ¡lidas:', opcoes);
        return false;
    }
    
    // âœ… CONVERTE para formato que o backend espera (apenas textos)
    const opcoesParaBackend = opcoes.map(opcao => {
        return opcao.texto || opcao; // Pega apenas o texto
    });
    
    console.log('ðŸ’¾ Salvando opÃ§Ãµes (convertidas):', opcoesParaBackend);
    
    try {
        const response = await fetch(`${BACKEND_URL}/api/opcoes-danos-defeito`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ opcoes: opcoesParaBackend }) // âœ… Envia array de strings
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('âœ… OpÃ§Ãµes salvas com sucesso!');
            showNotification('Frases salvas!', 'success', 2000);
            return true;
        } else {
            throw new Error(result.error || 'Erro desconhecido');
        }
        
    } catch (error) {
        console.error('âŒ Erro ao salvar:', error);
        showNotification('Erro ao salvar frases: ' + error.message, 'error', 3000);
        return false;
    }
}

// âœ… ATUALIZE a funÃ§Ã£o adicionarNovoDefeitoLista
async function adicionarNovoDefeitoLista(sheetRange) {
    const menu = document.querySelector('.menu-danos-defeito');
    const input = menu.querySelector('#input-dano-customizado');
    const textoCustomizado = input.value.trim();
    
    if (!textoCustomizado) {
        showNotification('Digite um texto para adicionar', 'warning');
        return;
    }
    
    opcoesDanosDefeito = await carregarOpcoesDanosDefeito();
    
    // Verifica se jÃ¡ existe (agora por texto)
    const jaExiste = opcoesDanosDefeito.some(opcao => 
        (opcao.texto || opcao) === textoCustomizado
    );
    
    if (!jaExiste) {
        // âœ… ADICIONA COMO OBJETO COM QUANTIDADE
        opcoesDanosDefeito.push({
            texto: textoCustomizado,
            quantidade: 1
        });
        
        const salvou = await salvarOpcoesDanosDefeito(opcoesDanosDefeito);
        
        if (salvou) {
            // Adiciona diretamente Ã  cÃ©lula tambÃ©m
            const celula = document.querySelector(`td [data-sheet-range="${sheetRange}"]`);
            if (celula) {
                const textoAtual = celula.textContent.trim();
                const novoTexto = textoAtual ? `${textoAtual}, ${textoCustomizado}` : textoCustomizado;
                
                celula.textContent = novoTexto;
                const event = new Event('blur');
                celula.dispatchEvent(event);
            }
            
            input.value = '';
            fecharMenuDanos();
            
            setTimeout(() => {
                const botao = document.querySelector('.opcao-danos-btn');
                if (botao) mostrarOpcoesDanos(botao, sheetRange);
            }, 100);
        }
    } else {
        showNotification('Esta frase jÃ¡ existe na lista', 'info');
    }
}


/**
 * Mostra o menu de opÃ§Ãµes de danos/defeitos - ATUALIZADA
 */
async function mostrarOpcoesDanos(botao, sheetRange) {
    // âœ… CARREGA SEMPRE DO BACKEND (opÃ§Ãµes mais recentes)
    opcoesDanosDefeito = await carregarOpcoesDanosDefeito();
    
    // âœ… GARANTIR que Ã© array
    if (!Array.isArray(opcoesDanosDefeito)) {
        console.error('âŒ OpÃ§Ãµes nÃ£o Ã© array, usando fallback');
        opcoesDanosDefeito = [
            "Caixa amassada",
            "Tampa com defeito", 
            "Veio porÃ©m com outro cÃ³digo",
            "Embalagem violada",
            "Produto avariado",
            "Falta componente"
        ];
    }
    
    console.log('âœ… OpÃ§Ãµes carregadas para menu:', opcoesDanosDefeito);
    
    const celula = botao.closest('td');
    const elementoEditavel = celula.querySelector('[contenteditable="true"]');
    const textoAtual = elementoEditavel.textContent;
    
    // Remove menu anterior se existir
    const menuAnterior = document.querySelector('.menu-danos-defeito');
    if (menuAnterior) menuAnterior.remove();
    
    // Cria novo menu
    const menu = document.createElement('div');
    menu.className = 'menu-danos-defeito absolute z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-2 min-w-64';
    
    let html = `
        <div class="text-sm font-medium text-gray-700 mb-2">Adicionar defeito:</div>
        <div class="space-y-1 max-h-72 overflow-y-auto" id="lista-opcoes-danos">`;
    
 
    // âœ… BOTÃ•ES COM QUANTIDADE - NOVO FORMATO
opcoesDanosDefeito.forEach((opcao, index) => {
    const texto = opcao.texto || opcao; // Compatibilidade com dados antigos
    const quantidade = opcao.quantidade || 1;
    
    html += `
        <div class="flex items-center justify-between hover:bg-blue-50 rounded px-2 py-1">
            <!-- âœ… CONTROLE DE QUANTIDADE -->
            <div class="flex items-center gap-1 mr-2">
                <!-- BotÃ£o - -->
                <button onclick="alterarQuantidadeDano(${index}, -1, event)"
                        class="w-5 h-5 flex items-center justify-center bg-gray-200 rounded text-xs hover:bg-gray-300">
                    âˆ’
                </button>
                
                <!-- NÃºmero -->
                <div class="w-6 h-5 flex items-center justify-center bg-white border border-gray-300 rounded text-xs font-medium">
                    ${quantidade}
                </div>
                
                <!-- BotÃ£o + -->
                <button onclick="alterarQuantidadeDano(${index}, 1, event)"
                        class="w-5 h-5 flex items-center justify-center bg-gray-200 rounded text-xs hover:bg-gray-300">
                    +
                </button>
            </div>
            
            <!-- âœ… TEXTO DA OPÃ‡ÃƒO -->
            <button onclick="adicionarOpcaoDanoComQuantidade(${index}, '${sheetRange}')"
                    class="flex-1 text-left text-sm pr-2 truncate">
                ${texto}
            </button>
            
            <!-- âœ… BOTÃƒO REMOVER -->
            <button onclick="removerOpcaoDano('${texto.replace(/'/g, "\\'")}', event)"
                    class="text-red-500 text-xs px-2 py-1 rounded hover:bg-red-100 border border-red-300 ml-1"
                    title="Remover opÃ§Ã£o">
                Ã—
            </button>
        </div>
    `;
});
    
    // Campo para texto customizado COM BOTÃƒO +
    html += `
<div class="space-y-1 max-h-64 overflow-y-auto" id="lista-opcoes-danos" style="scroll-behavior: smooth;">
            <div class="text-xs text-gray-600 mb-1">Adicionar novo defeito:</div>
            <div class="flex gap-1">
                <input type="text" 
                       id="input-dano-customizado" 
                       placeholder="Digite novo defeito..." 
                       class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm">
                <button onclick="adicionarNovoDefeitoLista('${sheetRange}')" 
                        class="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm flex items-center justify-center">
                    <span class="text-xs">+</span>
                </button>
            </div>
        </div>
        
        <div class="mt-2">
            <button onclick="fecharMenuDanos()" 
                    class="w-full px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">
                Fechar
            </button>
        </div>
    `;
    
    menu.innerHTML = html;
    
// âœ… POSICIONAMENTO CORRIGIDO - MENU NA ESQUERDA
const rect = botao.getBoundingClientRect();
const menuWidth = 280; // âœ… Aumentado para os controles

// âœ… ABRE O MENU Ã€ ESQUERDA DO BOTÃƒO (nÃ£o sobreposto)
let leftPosition = rect.left + window.scrollX - menuWidth - 70; // âœ… 20px de overlap

// âœ… Se nÃ£o couber na esquerda, abre Ã  direita
if (leftPosition < 10) {
    leftPosition = rect.right + window.scrollX - 10;
}

// âœ… Garante que nÃ£o sai da tela pela direita
const maxLeft = window.innerWidth - menuWidth - 10;
if (leftPosition > maxLeft) {
    leftPosition = maxLeft;
}
// âœ… POSICIONAMENTO VERTICAL - abaixo do botÃ£o (consistente)
let topPosition = rect.bottom + window.scrollY + 5;

// âœ… Se nÃ£o couber embaixo, abre em cima
if (topPosition + 170 > window.innerHeight + window.scrollY) {
    topPosition = rect.top + window.scrollY - 170 - 5;
}

menu.style.top = `${topPosition}px`;
menu.style.left = `${leftPosition}px`;

console.log('ðŸŽ¯ Menu posicionado - Left:', leftPosition, 'Top:', topPosition);
	

    
    document.body.appendChild(menu);
    
    // Foca no input customizado
    setTimeout(() => {
        const input = document.getElementById('input-dano-customizado');
        if (input) input.focus();
    }, 100);
}


// âœ… FUNÃ‡ÃƒO CORRIGIDA - USA AS CLASSES REAIS ENCONTRADAS NO DEBUG
function alterarQuantidadeDano(index, mudanca, event) {
    event.stopPropagation();
    console.log('ðŸŽ¯ CLICADO: index', index, 'mudanÃ§a', mudanca);
    
    if (opcoesDanosDefeito[index]) {
        // Calcula nova quantidade
        let novaQuantidade = (opcoesDanosDefeito[index].quantidade || 1) + mudanca;
        novaQuantidade = Math.max(1, Math.min(100, novaQuantidade));
        
        console.log('ðŸŽ¯ NOVA QUANTIDADE:', novaQuantidade);
        
        // Atualiza na memÃ³ria
        opcoesDanosDefeito[index].quantidade = novaQuantidade;
        
        // âœ… CORREÃ‡ÃƒO 1: USA AS CLASSES REAIS (w-6 em vez de w-8)
        const todosOsNumeros = document.querySelectorAll('div.w-6.h-5');
        console.log('ðŸŽ¯ NÃšMEROS ENCONTRADOS:', todosOsNumeros.length);
        
        if (todosOsNumeros[index]) {
            todosOsNumeros[index].textContent = novaQuantidade;
            console.log('âœ… NÃšMERO ATUALIZADO VISUALMENTE!');
            return;
        }
        
        // âœ… CORREÃ‡ÃƒO 2: MÃ‰TODO ALTERNATivo se o primeiro nÃ£o funcionar
        console.log('ðŸŽ¯ Tentando mÃ©todo alternativo...');
        const todosDivsComNumeros = document.querySelectorAll('.menu-danos-defeito div');
        todosDivsComNumeros.forEach((div, i) => {
            if (div.textContent && div.textContent.trim() === '1') { // Procura por "1"
                console.log('ðŸŽ¯ Div com nÃºmero 1 encontrada no Ã­ndice:', i);
                // Se for a que corresponde ao index certo, atualiza
                if (i >= index * 7 && i <= index * 7 + 10) { // AproximaÃ§Ã£o
                    div.textContent = novaQuantidade;
                    console.log('âœ… NÃºmero atualizado pelo mÃ©todo alternativo!');
                }
            }
        });
    }
}

// âœ… FUNÃ‡ÃƒO PARA ADICIONAR COM QUANTIDADE
function adicionarOpcaoDanoComQuantidade(index, sheetRange) {
    if (opcoesDanosDefeito[index]) {
        const opcao = opcoesDanosDefeito[index];
        const texto = opcao.texto || opcao;
        const quantidade = opcao.quantidade || 1;
        
        const textoComQuantidade = quantidade > 1 ? `${quantidade} ${texto}` : texto;
        
        const celula = document.querySelector(`td [data-sheet-range="${sheetRange}"]`);
        
        if (celula) {
            const textoAtual = celula.textContent.trim();
            const novoTexto = textoAtual ? `${textoAtual}, ${textoComQuantidade}` : textoComQuantidade;
            
            celula.textContent = novoTexto;
            
            // Dispara o evento blur para salvar automaticamente
            const event = new Event('blur');
            celula.dispatchEvent(event);
            
            fecharMenuDanos();
        }
    }
}
		
// âœ… ATUALIZE a funÃ§Ã£o antiga para compatibilidade
function adicionarOpcaoDano(opcao, sheetRange) {
    // Para compatibilidade com dados antigos
    const texto = typeof opcao === 'string' ? opcao : (opcao.texto || opcao);
    const quantidade = opcao.quantidade || 1;
    
    const textoComQuantidade = quantidade > 1 ? `${quantidade} ${texto}` : texto;
    
    const celula = document.querySelector(`td [data-sheet-range="${sheetRange}"]`);
    
    if (celula) {
        const textoAtual = celula.textContent.trim();
        const novoTexto = textoAtual ? `${textoAtual}, ${textoComQuantidade}` : textoComQuantidade;
        
        celula.textContent = novoTexto;
        
        const event = new Event('blur');
        celula.dispatchEvent(event);
        
        fecharMenuDanos();
    }
}

/**
 * Fecha o menu
 */
function fecharMenuDanos() {
    const menu = document.querySelector('.menu-danos-defeito');
    if (menu) menu.remove();
}

// Fecha menu ao clicar fora
document.addEventListener('click', function(e) {
    if (!e.target.closest('.menu-danos-defeito') && !e.target.closest('.opcao-danos-btn')) {
        fecharMenuDanos();
    }
});

		/**
 * âœ… NOVA FUNÃ‡ÃƒO: APLICA FORMATAÃ‡ÃƒO CONDICIONAL NA ABA CONFERENCIA
 * - DiferenÃ§a negativa: Vermelho apenas na coluna DiferenÃ§a
 * - DiferenÃ§a positiva: Verde apenas na coluna DiferenÃ§a  
 * - Danos/Defeito preenchido: Vermelho suave apenas na coluna Danos/Defeito (texto preto)
 */
function aplicarConferenciaStyles(numCols) {
    const table = document.getElementById('conferencia-table');
    if (!table) return;

    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 7) return;

        const diferencaCell = cells[4]; // 5Âª coluna (DiferenÃ§a)
        const danosDefeitoCell = cells[6]; // 7Âª coluna (Danos/Defeito e Obs)
        
        // âœ… 1. LIMPAR TODAS AS CLASSES DE COR ANTERIORES
        if (diferencaCell) {
            diferencaCell.classList.remove('bg-fee2e2', 'text-b91c1c', 'bg-green-100', 'text-green-700');
        }
        
        // âœ… 2. VERIFICAR DIFERENÃ‡A 
        if (diferencaCell) {
            const diferencaText = diferencaCell.textContent.trim();
            const diferencaValue = parseFloat(diferencaText.replace(',', '.'));
            
            if (!isNaN(diferencaValue)) {
                if (diferencaValue < 0) {
                    // âœ… DIFERENÃ‡A NEGATIVA: VERMELHO APENAS NA COLUNA DIFERENÃ‡A
                    diferencaCell.classList.add('bg-fee2e2', 'text-b91c1c');
                } else if (diferencaValue > 0) {
                    // âœ… DIFERENÃ‡A POSITIVA: VERDE APENAS NA COLUNA DIFERENÃ‡A
                    diferencaCell.classList.add('bg-green-100', 'text-green-700');
                }
            }
        }

        // âœ… 3. VERIFICAR DANOS/DEFEITO PREENCHIDO - VERMELHO SUAVE COM TEXTO PRETO
        if (danosDefeitoCell) {
            // âœ… CORREÃ‡ÃƒO: VERIFICA APENAS O TEXTO REAL (nÃ£o o botÃ£o +)
            const elementoEditavel = danosDefeitoCell.querySelector('[contenteditable="true"]');
            const textoReal = elementoEditavel ? elementoEditavel.textContent.trim() : '';
            
            // Remove classes anteriores
            danosDefeitoCell.classList.remove('bg-red-100', 'bg-fee2e2', 'text-b91c1c');
            
            if (textoReal !== '') {
                // âœ… SÃ“ APLICA VERMELHO SE HOUVER TEXTO REAL DIGITADO
                danosDefeitoCell.classList.add('bg-red-100');
                
                // âœ… GARANTIR QUE O TEXTO FIQUE PRETO (nÃ£o vermelho)
                if (elementoEditavel) {
                    elementoEditavel.style.color = '#374151'; // Cor cinza escuro (texto normal)
                }
            } else {
                // âœ… SE ESTIVER VAZIA, GARANTIR COR NORMAL
                if (elementoEditavel) {
                    elementoEditavel.style.color = ''; // Volta para cor padrÃ£o
                }
            }
        }
    });
}



	// âœ… FUNÃ‡ÃƒO PARA REMOVER OPÃ‡ÃƒO (CORRIGIDA)
async function removerOpcaoDano(textoOpcao, event) {
    event.stopPropagation();
    
    if (confirm(`Deseja remover "${textoOpcao}" da lista?`)) {
        try {
            // âœ… CORREÃ‡ÃƒO: Remove por texto, nÃ£o por objeto completo
            opcoesDanosDefeito = opcoesDanosDefeito.filter(item => {
                const textoItem = item.texto || item;
                return textoItem !== textoOpcao;
            });
            
            // Salva no Google Sheets
            const salvou = await salvarOpcoesDanosDefeito(opcoesDanosDefeito);
            
            if (salvou) {
                showNotification(`"${textoOpcao}" removido da lista`, 'success', 2000);
                
                // Fecha e reabre o menu para atualizar
                fecharMenuDanos();
                setTimeout(() => {
                    const botao = document.querySelector('.opcao-danos-btn');
                    if (botao) {
                        const celula = botao.closest('td');
                        const elementoEditavel = celula.querySelector('[contenteditable="true"]');
                        const sheetRange = elementoEditavel.getAttribute('data-sheet-range');
                        mostrarOpcoesDanos(botao, sheetRange);
                    }
                }, 100);
            }
        } catch (error) {
            console.error('Erro ao remover opÃ§Ã£o:', error);
            showNotification('Erro ao remover opÃ§Ã£o', 'error');
        }
    }
}


		// âœ… FUNÃ‡ÃƒO MELHORADA PARA CAPTURAR ENTER
function handleDanosEnterKey(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Impede a quebra de linha
        
        // Dispara o evento blur para salvar imediatamente
        const blurEvent = new Event('blur');
        event.target.dispatchEvent(blurEvent);
        
        // Remove o foco
        event.target.blur();
    }
}


// ðŸ”§ SISTEMA MODO DESKTOP PARA MOBILE
let modoDesktopAtivo = false;
let viewportOriginal = '';

function alternarModoDesktop() {
    const viewportMeta = document.querySelector('meta[name="viewport"]');
    
    if (!modoDesktopAtivo) {
        // âœ… ATIVAR MODO DESKTOP
        modoDesktopAtivo = true;
        
        if (!viewportOriginal && viewportMeta) {
            viewportOriginal = viewportMeta.getAttribute('content');
        }
        
        if (viewportMeta) {
            viewportMeta.setAttribute('content', 'width=1024, initial-scale=0.5, maximum-scale=5.0, user-scalable=yes');
        }
        
        document.documentElement.classList.add('modo-desktop-ativo');
        document.body.classList.add('modo-desktop-ativo');
        
        // ðŸ”¥ CHAMAR A FUNÃ‡ÃƒO QUE FORÃ‡A A VISIBILIDADE
        setTimeout(() => {
            forcarVisibilidadeBotaoDesktop();
            atualizarBotoesDesktop();
        }, 100);
        
        showNotification('ðŸ–¥ï¸ Modo Desktop ativado', 'success', 3000);
        
    } else {
        // âœ… DESATIVAR MODO DESKTOP
        modoDesktopAtivo = false;
        
        if (viewportMeta && viewportOriginal) {
            viewportMeta.setAttribute('content', viewportOriginal);
        } else {
            viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        }
        
        document.documentElement.classList.remove('modo-desktop-ativo');
        document.body.classList.remove('modo-desktop-ativo', 'modo-desktop-botao-ativo');
        
        atualizarBotoesDesktop();
        showNotification('ðŸ“± Modo Mobile ativado', 'info', 3000);
    }
    
    salvarEstadoDesktop();
}

/**
 * âœ… ATUALIZAR TODOS OS BOTÃ•ES DESKTOP - VERSÃƒO CORRIGIDA
 */
function atualizarBotoesDesktop() {
    const botoes = document.querySelectorAll('.btn-desktop-mode');
    const textos = document.querySelectorAll('[id^="desktop-mode-text"]');
    
    console.log('ðŸ”„ Atualizando botÃµes desktop. Modo ativo:', modoDesktopAtivo);
    console.log('ðŸ” BotÃµes encontrados:', botoes.length);
    
    botoes.forEach(botao => {
        // ðŸ”¥ FORÃ‡AR display flex sempre que estiver no modo desktop
        if (modoDesktopAtivo) {
            botao.style.display = 'flex !important';
            botao.style.visibility = 'visible !important';
            botao.style.opacity = '1 !important';
        }
    });
    
    if (modoDesktopAtivo) {
        // Modo Desktop ativo
        botoes.forEach(botao => {
            botao.style.background = '#10b981';
            botao.style.color = 'white';
            botao.style.borderColor = '#059669';
        });
        textos.forEach(texto => {
            if (texto) texto.textContent = 'Modo Mobile';
        });
    } else {
        // Modo Mobile ativo
        botoes.forEach(botao => {
            botao.style.background = '#d1fae5';
            botao.style.color = '#065f46';
            botao.style.borderColor = '#a7f3d0';
        });
        textos.forEach(texto => {
            if (texto) texto.textContent = 'Modo Desktop';
        });
    }
}
/**
 * âœ… SALVAR ESTADO DO MODO DESKTOP
 */
function salvarEstadoDesktop() {
    localStorage.setItem('modoDesktopMobile', modoDesktopAtivo.toString());
    if (viewportOriginal) {
        localStorage.setItem('viewportOriginal', viewportOriginal);
    }
}

/**
 * âœ… CARREGAR ESTADO DO MODO DESKTOP
 */
function carregarEstadoDesktop() {
    const estadoSalvo = localStorage.getItem('modoDesktopMobile');
    const viewportSalvo = localStorage.getItem('viewportOriginal');
    
    if (viewportSalvo) {
        viewportOriginal = viewportSalvo;
    }
    
    if (estadoSalvo === 'true') {
        // Aplica modo desktop apÃ³s um delay para garantir que o DOM estÃ¡ pronto
        setTimeout(() => {
            modoDesktopAtivo = true;
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                viewportMeta.setAttribute('content', 'width=1024, initial-scale=0.5, maximum-scale=5.0, user-scalable=yes');
            }
            document.documentElement.classList.add('modo-desktop-ativo');
            atualizarBotoesDesktop();
        }, 500);
    }
}

/**
 * âœ… VERIFICAR E APLICAR MODO DESKTOP AO MUDAR DE ABA
 */
function verificarModoDesktopAba() {
    if (modoDesktopAtivo) {
        atualizarBotoesDesktop();
    }
}

/**
 * âœ… FORÃ‡AR VISIBILIDADE DO BOTÃƒO - SOLUÃ‡ÃƒO DEFINITIVA
 */
function forcarVisibilidadeBotaoDesktop() {
    if (modoDesktopAtivo) {
        const botoes = document.querySelectorAll('.btn-desktop-mode');
        console.log('ðŸ” Procurando botÃµes desktop...', botoes.length);
        
        botoes.forEach((botao, index) => {
            console.log(`ðŸŽ¯ BotÃ£o ${index}:`, botao);
            
            //  FORÃ‡AR todos os estilos necessÃ¡rios
            botao.style.cssText = `
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: relative !important;
                z-index: 9999 !important;
                background: #10b981 !important;
                color: white !important;
                border: 1px solid #059669 !important;
                padding: 8px 16px !important;
                border-radius: 8px !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                cursor: pointer !important;
            `;
        });
        
        // TambÃ©m forÃ§ar via classe
        document.body.classList.add('modo-desktop-botao-ativo');
    }
}

//  ADICIONE ESTE CSS EXTRA
const estiloExtra = `
    .modo-desktop-botao-ativo .btn-desktop-mode {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: #10b981 !important;
        color: white !important;
        border: 1px solid #059669 !important;
    }
`;
const styleSheet = document.createElement('style');
styleSheet.textContent = estiloExtra;
document.head.appendChild(styleSheet);
		
		
    </script>
</body>
</html>
